name: Build Directus Electron App

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

permissions:
  contents: write

jobs:
  extract-directus:
    runs-on: ubuntu-latest
    steps:
      - name: Extract Directus from Docker
        run: |
          # æ‹‰å–é•œåƒ
          docker pull directus/directus:11.5.1
          docker create --name directus-temp directus/directus:11.5.1
          docker cp directus-temp:/directus ./directus-files
          docker rm directus-temp

          echo "=== Docker æå–æ–‡ä»¶ç»“æ„ ==="
          if command -v tree >/dev/null; then
            tree directus-files/ || true
          else
            find directus-files -print | sed -e 's;[^/]*/;|____;g;s;____|; |;g' | head -50
          fi

          echo ""
          echo "=== æŸ¥æ‰¾å¯èƒ½çš„ CLI å…¥å£ ==="
          find directus-files \( -name "cli.js" -o -name "index.js" -o -name "directus" \) | head -20 || echo "æœªæ‰¾åˆ°"

          # è§£å†³ç¬¦å·é“¾æ¥
          echo "Resolving symlinks..."
          cd directus-files
          find . -type l | while read link; do
            target=$(readlink "$link")
            if [ -e "$target" ]; then
              echo "Resolving: $link -> $target"
              rm "$link"
              cp -r "$target" "$link" 2>/dev/null || echo "Skipped: $link"
            else
              echo "Broken link: $link"
              rm "$link"
            fi
          done
          cd ..

          # æ‰“åŒ…
          tar --dereference -czf directus-files.tar.gz directus-files
          echo "Directus files packaged successfully"

      - name: Upload Directus files
        uses: actions/upload-artifact@v4
        with:
          name: directus-files
          path: directus-files.tar.gz
          retention-days: 1

  build-windows:
    needs: extract-directus
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Download Directus files
        uses: actions/download-artifact@v4
        with:
          name: directus-files

      - name: Extract Directus files
        shell: bash
        run: |
          # è§£å‹
          tar -xzf directus-files.tar.gz

          # åˆ›å»ºç›®æ ‡ç›®å½•
          mkdir -p directus-app

          # å¼ºåˆ¶å¤åˆ¶æ‰€æœ‰å†…å®¹ï¼ˆåŒ…æ‹¬éšè—æ–‡ä»¶ï¼‰
          cp -r directus-files/* directus-app/ 2>/dev/null || true
          cp -r directus-files/.* directus-app/ 2>/dev/null || true

          # éªŒè¯
          echo "=== directus-app ç›®å½•å†…å®¹ ==="
          ls -la directus-app/ | head -30

          echo ""
          echo "=== æŸ¥æ‰¾ CLI å…¥å£ï¼ˆé¢„è¯Šæ–­ï¼‰==="
          find directus-app \( -name "cli.js" -o -name "index.js" -o -name "directus" \) | head -10 || echo "æœªæ‰¾åˆ°"

          if [ ! "$(ls -A directus-app)" ]; then
            echo "ERROR: directus-app ç›®å½•ä¸ºç©ºï¼è§£å‹æˆ–å¤åˆ¶å¤±è´¥ã€‚"
            exit 1
          fi

      - name: Create Electron app structure
        shell: bash
        run: |
          # package.json
          cat > package.json << 'EOF'
          {
            "name": "directus-desktop",
            "version": "${{ github.event.inputs.version || '1.0.0' }}",
            "description": "Directus Desktop Application for Windows",
            "main": "main.js",
            "scripts": {
              "start": "electron .",
              "build": "electron-builder --win --x64"
            },
            "author": "Directus Desktop",
            "license": "MIT",
            "devDependencies": {
              "electron": "^28.0.0",
              "electron-builder": "^24.9.1"
            },
            "build": {
              "appId": "com.directus.desktop",
              "productName": "Directus",
              "win": {
                "target": [
                  {
                    "target": "nsis",
                    "arch": ["x64"]
                  }
                ],
                "icon": "icon.ico"
              },
              "files": [
                "main.js",
                "preload.js",
                "directus-app/**/*",
                "!directus-app/node_modules/**/{CHANGELOG.md,README.md,README,readme.md,readme}",
                "!directus-app/node_modules/**/{test,__tests__,tests,powered-test,example,examples}",
                "!directus-app/node_modules/**/*.d.ts",
                "!directus-app/node_modules/.bin"
              ],
              "asarUnpack": [
                "directus-app/**/*.node",
                "directus-app/node_modules/better-sqlite3/**/*"
              ],
              "directories": {
                "output": "dist"
              },
              "nsis": {
                "oneClick": false,
                "allowToChangeInstallationDirectory": true,
                "createDesktopShortcut": true,
                "createStartMenuShortcut": true
              }
            }
          }
          EOF

          # preload.js
          cat > preload.js << 'EOF'
          const { contextBridge, ipcRenderer } = require('electron');
          contextBridge.exposeInMainWorld('electronAPI', {
            getAppPath: () => ipcRenderer.invoke('get-app-path'),
            openExternal: (url) => ipcRenderer.invoke('open-external', url)
          });
          EOF

          # main.jsï¼ˆå¢å¼ºç‰ˆè·¯å¾„æŸ¥æ‰¾ï¼‰
          cat > main.js << 'EOF'
          const { app, BrowserWindow, ipcMain, shell, dialog } = require('electron');
          const path = require('path');
          const { spawn } = require('child_process');
          const fs = require('fs');
          const os = require('os');

          let mainWindow;
          let directusProcess;
          const PORT = 8055;
          let startupLogs = [];

          function getDirectusPath() {
            if (app.isPackaged) {
              return path.join(process.resourcesPath, 'app.asar.unpacked', 'directus-app');
            }
            return path.join(__dirname, 'directus-app');
          }

          function startDirectus() {
            const directusAppPath = getDirectusPath();
            const userDataPath = app.getPath('userData');
            const dbPath = path.join(userDataPath, 'database', 'directus.db');
            const logPath = path.join(userDataPath, 'directus.log');

            const logStream = fs.createWriteStream(logPath, { flags: 'a' });
            function log(msg) {
              const timestamp = new Date().toISOString();
              const logMsg = `[${timestamp}] ${msg}\n`;
              logStream.write(logMsg);
              console.log(msg);
              startupLogs.push(msg);
            }

            log('=== Directus å¯åŠ¨å¼€å§‹ ===');
            log(`App path: ${directusAppPath}`);
            log(`Database path: ${dbPath}`);
            log(`Log path: ${logPath}`);

            const dbDir = path.dirname(dbPath);
            if (!fs.existsSync(dbDir)) {
              fs.mkdirSync(dbDir, { recursive: true });
              log(`Created database directory: ${dbDir}`);
            }

            // æ™ºèƒ½æŸ¥æ‰¾ CLI
            const possiblePaths = [
              path.join(directusAppPath, 'cli.js'),
              path.join(directusAppPath, 'index.js'),
              path.join(directusAppPath, 'dist', 'cli.js'),
              path.join(directusAppPath, 'dist', 'index.js'),
              path.join(directusAppPath, 'bin', 'cli.js'),
              path.join(directusAppPath, 'node_modules', 'directus', 'dist', 'cli', 'index.js'),
              path.join(directusAppPath, 'node_modules', 'directus', 'dist', 'index.js'),
              path.join(directusAppPath, 'node_modules', '.bin', 'directus'),
              path.join(directusAppPath, 'node_modules', '.bin', 'directus.cmd'),
            ];

            let directusCliPath = null;
            for (const p of possiblePaths) {
              log(`Checking: ${p}`);
              if (fs.existsSync(p)) {
                directusCliPath = p;
                log(`Found CLI: ${p}`);
                break;
              }
            }

            // æ·±åº¦æœç´¢
            if (!directusCliPath && fs.existsSync(directusAppPath)) {
              log("Deep searching for CLI...");
              const findCmd = os.platform() === 'win32'
                ? `dir "${directusAppPath}" /s /b | findstr /i "cli\\.js index\\.js directus$"`
                : `find "${directusAppPath}" -type f \\( -name "cli.js" -o -name "index.js" -o -name "directus" \\) | head -1`;

              const { execSync } = require('child_process');
              try {
                const output = execSync(findCmd, { encoding: 'utf8', stdio: ['pipe', 'pipe', 'ignore'] });
                const candidate = output.trim().split('\n')[0];
                if (candidate) {
                  directusCliPath = candidate;
                  log(`Deep search found: ${directusCliPath}`);
                }
              } catch (e) {
                log(`Deep search error: ${e.message}`);
              }
            }

            if (!directusCliPath) {
              log('ERROR: CLI not found!');
              try {
                const files = fs.readdirSync(directusAppPath).slice(0, 30);
                files.forEach(f => log(`  - ${f}`));
              } catch (e) {
                log(`Cannot read dir: ${e.message}`);
              }
              showErrorDialog('å¯åŠ¨å¤±è´¥', `æ‰¾ä¸åˆ° Directus CLI\nç›®å½•: ${directusAppPath}`);
              return;
            }

            const env = {
              ...process.env,
              PORT: PORT.toString(),
              HOST: '0.0.0.0',
              PUBLIC_URL: `http://localhost:${PORT}`,
              DB_CLIENT: 'sqlite3',
              DB_FILENAME: dbPath,
              STORAGE_LOCATIONS: 'local',
              STORAGE_LOCAL_ROOT: path.join(userDataPath, 'uploads'),
              EXTENSIONS_PATH: path.join(userDataPath, 'extensions'),
              ADMIN_EMAIL: 'admin@example.com',
              ADMIN_PASSWORD: 'admin',
              KEY: 'directus-desktop-key-' + Math.random().toString(36),
              SECRET: 'directus-desktop-secret-' + Math.random().toString(36),
              TELEMETRY: 'false',
              NODE_ENV: 'production',
              LOG_LEVEL: 'info'
            };

            log(`Spawning: node "${directusCliPath}" start`);
            directusProcess = spawn(process.execPath, [directusCliPath, 'start'], {
              env, cwd: directusAppPath, stdio: ['ignore', 'pipe', 'pipe']
            });

            directusProcess.stdout.on('data', data => {
              const msg = data.toString().trim();
              log(`[STDOUT] ${msg}`);
              if (msg.includes('Server started') || msg.includes('listening')) {
                log('Directus å¯åŠ¨æˆåŠŸï¼');
              }
            });

            directusProcess.stderr.on('data', data => {
              const msg = data.toString().trim();
              if (!msg.includes('DeprecationWarning') && !msg.includes('ExperimentalWarning')) {
                log(`[STDERR] ${msg}`);
              }
            });

            directusProcess.on('error', err => log(`Process error: ${err.message}`));
            directusProcess.on('close', code => log(`Process exited: ${code}`));
          }

          function showErrorDialog(title, message) {
            if (mainWindow) {
              dialog.showErrorBox(title, message + `\n\næ—¥å¿—: ${path.join(app.getPath('userData'), 'directus.log')}`);
            }
          }

          function createWindow() {
            mainWindow = new BrowserWindow({
              width: 1400, height: 900,
              webPreferences: { nodeIntegration: false, contextIsolation: true, preload: path.join(__dirname, 'preload.js') },
              icon: path.join(__dirname, 'icon.ico'), show: false
            });

            mainWindow.loadURL(`data:text/html,${encodeURIComponent(`
              <html><body style="margin:0;font-family:-apple-system,Segoe UI;background:#f0f0f0;color:#333;display:flex;align-items:center;justify-content:center;height:100vh;">
                <div style="text-align:center;">
                  <h1>Directus å¯åŠ¨ä¸­...</h1>
                  <p>é¦–æ¬¡å¯åŠ¨éœ€è¦åˆå§‹åŒ–æ•°æ®åº“ï¼Œè¯·ç¨å€™</p>
                  <div style="width:300px;height:4px;background:#ddd;border-radius:2px;overflow:hidden;margin:20px auto;">
                    <div style="width:100%;height:100%;background:#667eea;animation:slide 1.5s infinite;"></div>
                  </div>
                  <button onclick="showLogs()" style="padding:8px 16px;margin-top:20px;">æŸ¥çœ‹æ—¥å¿—</button>
                </div>
                <style>@keyframes slide{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}</style>
                <script>
                  function showLogs() {
                    if (window.electronAPI) {
                      window.electronAPI.openExternal('file://' + window.electronAPI.getAppPath() + '/directus.log');
                    }
                  }
                </script>
              </body></html>
            `)}`);

            mainWindow.once('ready-to-show', () => mainWindow.show());
            setTimeout(() => checkDirectusReady(), 15000);
          }

          function checkDirectusReady(attempts = 0) {
            if (attempts > 60) return showErrorDialog('å¯åŠ¨è¶…æ—¶', 'è¯·æ£€æŸ¥æ—¥å¿—');
            const http = require('http');
            const req = http.request({ hostname: 'localhost', port: PORT, path: '/server/health', timeout: 3000 }, res => {
              if (res.statusCode === 200) {
                setTimeout(() => mainWindow.loadURL(`http://localhost:${PORT}/admin`), 2000);
              } else {
                setTimeout(() => checkDirectusReady(attempts + 1), 2000);
              }
            });
            req.on('error', () => setTimeout(() => checkDirectusReady(attempts + 1), 2000));
            req.on('timeout', () => { req.destroy(); setTimeout(() => checkDirectusReady(attempts + 1), 2000); });
            req.end();
          }

          ipcMain.handle('get-app-path', () => app.getPath('userData'));
          ipcMain.handle('open-external', (e, url) => shell.openExternal(url));

          app.on('ready', () => {
            startDirectus();
            setTimeout(createWindow, 2000);
            const { globalShortcut } = require('electron');
            globalShortcut.register('F12', () => mainWindow?.webContents.toggleDevTools());
          });

          app.on('window-all-closed', () => { if (directusProcess) directusProcess.kill(); if (process.platform !== 'darwin') app.quit(); });
          app.on('before-quit', () => { if (directusProcess) { directusProcess.kill('SIGTERM'); setTimeout(() => directusProcess.kill('SIGKILL'), 1000); } });
          EOF

          echo "Electron app structure created with enhanced CLI detection"

      - name: Install Electron dependencies
        run: npm install

      - name: Build Electron app
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npm run build

      - name: Get version
        id: version
        shell: bash
        run: |
          if [ "${{ github.ref_type }}" == "tag" ]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION="${{ github.event.inputs.version }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: List build output
        shell: bash
        run: |
          echo "Build output:"
          ls -lh dist/ || echo "dist/ not found"

      - name: Rename and prepare installer
        shell: bash
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          cd dist
          INSTALLER_FILE=$(find . -maxdepth 1 -name "*.exe" -type f | head -n 1)
          if [ -n "$INSTALLER_FILE" ]; then
            NEW_NAME="Directus-Desktop-${VERSION}-Windows-x64-Setup.exe"
            mv "$INSTALLER_FILE" "$NEW_NAME"
            echo "installer_name=$NEW_NAME" >> $GITHUB_OUTPUT
          else
            echo "No .exe found!"
            exit 1
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Directus Desktop v${{ steps.version.outputs.version }}
          body: |
            ## Directus Desktop v${{ steps.version.outputs.version }}

            åŸºäº **Directus 11.5.1** çš„ Windows æ¡Œé¢ç‰ˆæœ¬

            ### ä¸‹è½½å®‰è£…
            1. ä¸‹è½½ `Directus-Desktop-${{ steps.version.outputs.version }}-Windows-x64-Setup.exe`
            2. åŒå‡»å®‰è£…
            3. é¦–æ¬¡å¯åŠ¨ç­‰å¾… 15 ç§’
            4. ä½¿ç”¨ `admin@example.com` / `admin` ç™»å½•

            ### ğŸ“‚ æ•°æ®å­˜å‚¨ä½ç½®
            
            æ‰€æœ‰æ•°æ®ä¿å­˜åœ¨ï¼š
            ```
            C:\Users\<ä½ çš„ç”¨æˆ·å>\AppData\Roaming\directus-desktop\
            â”œâ”€â”€ database\
            â”‚   â””â”€â”€ directus.db      (æ•°æ®åº“æ–‡ä»¶)
            â”œâ”€â”€ uploads\             (ä¸Šä¼ çš„æ–‡ä»¶)
            â””â”€â”€ extensions\          (æ‰©å±•æ’ä»¶)
            ```
            
            ### ğŸ’¡ ä½¿ç”¨æç¤º
            
            - è®¿é—®åœ°å€ï¼š`http://localhost:8055/admin`
            - å¯ä»¥å¤šå¼€ï¼ˆä¼šè‡ªåŠ¨ä½¿ç”¨ä¸åŒç«¯å£ï¼‰
            - å…³é—­çª—å£å³åœæ­¢æœåŠ¡
            - å¸è½½ä¸ä¼šåˆ é™¤æ•°æ®ï¼Œéœ€æ‰‹åŠ¨åˆ é™¤ä¸Šè¿°ç›®å½•
            
            ### ğŸ› é‡åˆ°é—®é¢˜ï¼Ÿ
            
            - å¦‚æœå¯åŠ¨å¤±è´¥ï¼Œæ£€æŸ¥ç«¯å£ 8055 æ˜¯å¦è¢«å ç”¨
            - å¦‚æœå¿˜è®°å¯†ç ï¼Œå¯ä»¥åˆ é™¤æ•°æ®åº“æ–‡ä»¶é‡æ–°åˆå§‹åŒ–
            - æ›´å¤šé—®é¢˜è¯·æäº¤ Issue
            
            ---
            
            ğŸ“¦ **æ–‡ä»¶ä¿¡æ¯**
            - ç‰ˆæœ¬ï¼šv${{ steps.version.outputs.version }}
            - Directus ç‰ˆæœ¬ï¼š11.5.1
            - æ¶æ„ï¼šWindows x64
            - å®‰è£…åŒ…å¤§å°ï¼š~150MB
            - å®‰è£…åå¤§å°ï¼š~300MB
          draft: false
          prerelease: false
          files: |
            dist/Directus-Desktop-${{ steps.version.outputs.version }}-Windows-x64-Setup.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
