name: Build Directus Electron App

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

# æ·»åŠ æƒé™é…ç½®
permissions:
  contents: write  # å…è®¸åˆ›å»º Release å’Œä¸Šä¼ æ–‡ä»¶

jobs:
  extract-directus:
    runs-on: ubuntu-latest
    
    steps:
      - name: Extract Directus from Docker
        run: |
          # æ‹‰å– Directus Docker é•œåƒ
          docker pull directus/directus:11.5.1
          
          # åˆ›å»ºå®¹å™¨å¹¶æå–æ–‡ä»¶
          docker create --name directus-temp directus/directus:11.5.1
          docker cp directus-temp:/directus ./directus-files
          docker rm directus-temp
          
          echo "=== Extracted Directus directory structure ==="
          ls -la directus-files/
          echo ""
          echo "=== Looking for CLI entry points ==="
          find directus-files -name "cli.js" -o -name "index.js" | head -20
          echo ""
          echo "=== Checking for package.json ==="
          find directus-files -name "package.json" | head -10
          echo ""
          
          # è§£å†³ç¬¦å·é“¾æ¥é—®é¢˜ï¼šå°†ç¬¦å·é“¾æ¥è½¬æ¢ä¸ºå®é™…æ–‡ä»¶
          echo "Resolving symlinks..."
          cd directus-files
          
          # æŸ¥æ‰¾æ‰€æœ‰ç¬¦å·é“¾æ¥å¹¶æ›¿æ¢ä¸ºå®é™…æ–‡ä»¶
          find . -type l | while read link; do
            target=$(readlink "$link")
            if [ -e "$target" ]; then
              echo "Resolving: $link -> $target"
              rm "$link"
              cp -r "$target" "$link" 2>/dev/null || echo "Skipped: $link"
            else
              echo "Broken link: $link"
              rm "$link"
            fi
          done
          
          cd ..
          
          echo ""
          echo "=== Final directory structure after resolving symlinks ==="
          ls -la directus-files/ | head -30
          echo ""
          
          # æ‰“åŒ…æˆ tar.gzï¼ˆä½¿ç”¨ --dereference è‡ªåŠ¨è§£å¼•ç”¨ç¬¦å·é“¾æ¥ï¼‰
          echo " tar.gz archive..."
          tar --dereference -czf directus-files.tar.gz directus-files
          
          echo ""
          echo "âœ“ Directus files extracted and packaged (symlinks resolved)"
          echo "Archive size: $(du -h directus-files.tar.gz)"
      
      - name: Upload Directus files
        uses: actions/upload-artifact@v4
        with:
          name: directus-files
          path: directus-files.tar.gz
          retention-days: 1

  build-windows:
    needs: extract-directus
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Download Directus files
        uses: actions/download-artifact@v4
        with:
          name: directus-files

      - name: Extract Directus files
        shell: bash
        run: |
          echo "=== Extraction Process Started ==="
          echo "Current directory:"
          pwd
          echo ""
          
          echo "Files in current directory:"
          ls -la
          echo ""
          
          # æ£€æŸ¥ tar.gz æ–‡ä»¶
          if [ ! -f "directus-files.tar.gz" ]; then
            echo "ERROR: directus-files.tar.gz not found!"
            exit 1
          fi
          
          echo "âœ“ Found directus-files.tar.gz"
          echo "File size: $(du -h directus-files.tar.gz)"
          echo ""
          
          # è§£å‹æ–‡ä»¶
          echo "Extracting archive..."
          tar -xzf directus-files.tar.gz
          
          echo ""
          echo "After extraction, files in current directory:"
          ls -la
          echo ""
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ directus-files ç›®å½•
          if [ -d "directus-files" ]; then
            echo "âœ“ directus-files directory found"
            echo ""
            echo "Top-level contents of directus-files:"
            ls -la directus-files/ | head -30
            echo ""
            
            # æ£€æŸ¥å…³é”®æ–‡ä»¶ - ä¿®å¤ï¼šåªæŸ¥æ‰¾æ ¹ç›®å½•çš„ cli.js
            echo "Looking for Directus CLI files (root level only):"
            find directus-files -maxdepth 1 -name "cli.js" -type f 2>/dev/null || echo "  No cli.js in root"
            find directus-files -maxdepth 2 -path "*/cli/index.js" -type f 2>/dev/null | head -5 || echo "  No cli/index.js found"
            find directus-files -maxdepth 2 -path "*/dist/*.js" -type f 2>/dev/null | head -5 || echo "  No dist/*.js found"
            echo ""
            
            # é‡å‘½åä¸º directus-app
            echo "Renaming directus-files to directus-app..."
            mv directus-files directus-app
            
            echo "âœ“ Successfully renamed to directus-app"
            echo ""
            echo "Verification - directus-app exists:"
            ls -ld directus-app
            echo ""
            echo "Contents of directus-app (top 30):"
            ls -la directus-app/ | head -30
            
          else
            echo "ERROR: directus-files directory not found after extraction!"
            echo ""
            echo "Available files and directories:"
            ls -la
            echo ""
            echo "Trying to list tar contents (first 50 lines):"
            tar -tzf directus-files.tar.gz | head -50
            exit 1
          fi
          
          echo ""
          echo "=== Extraction Process Completed ==="


      - name: Verify Directus structure
        shell: bash
        run: |
          echo "=== Verifying Directus Structure ==="
          
          if [ ! -d "directus-app" ]; then
            echo "ERROR: directus-app directory does not exist!"
            exit 1
          fi
          
          echo "âœ“ directus-app directory exists"
          echo ""
          
          # æŸ¥æ‰¾ CLI å…¥å£ç‚¹ï¼ˆé™åˆ¶æ·±åº¦é¿å…è¾“å‡ºè¿‡å¤šï¼‰
          echo "Searching for Directus entry points..."
          
          # æ£€æŸ¥æ ¹ç›®å½•çš„ cli.js
          if [ -f "directus-app/cli.js" ]; then
            echo "  âœ“ Found: directus-app/cli.js"
          fi
          
          # æ£€æŸ¥ cli ç›®å½•
          if [ -d "directus-app/cli" ]; then
            echo "  âœ“ cli/ directory exists"
            ls -la directus-app/cli/ | head -10
          fi
          
          # æ£€æŸ¥ dist ç›®å½•
          if [ -d "directus-app/dist" ]; then
            echo "  âœ“ dist/ directory exists"
            ls -la directus-app/dist/ | head -10
          fi
          
          # æ£€æŸ¥ node_modules (ä»…æ£€æŸ¥å­˜åœ¨æ€§ï¼Œä¸åˆ—å‡ºå†…å®¹)
          if [ -d "directus-app/node_modules" ]; then
            echo "  âœ“ node_modules/ directory exists"
            echo "    Size: $(du -sh directus-app/node_modules 2>/dev/null || echo 'unknown')"
          fi
          
          # æ£€æŸ¥ package.json
          if [ -f "directus-app/package.json" ]; then
            echo "  âœ“ package.json exists"
            echo "    Checking for directus info:"
            grep -E '"name"|"version"' directus-app/package.json | head -5 || true
          fi
          
          echo ""
          echo "=== Verification Complete ==="


      - name: Create Electron app structure
        shell: bash
        run: |
          # åˆ›å»º package.json
          cat > package.json << 'EOF'
          {
            "name": "directus-desktop",
            "version": "${{ github.event.inputs.version || '1.0.0' }}",
            "description": "Directus Desktop Application for Windows",
            "main": "main.js",
            "scripts": {
              "start": "electron .",
              "build": "electron-builder --win --x64"
            },
            "author": "Directus Desktop",
            "license": "MIT",
            "devDependencies": {
              "electron": "^28.0.0",
              "electron-builder": "^24.9.1"
            },
            "build": {
              "appId": "com.directus.desktop",
              "productName": "Directus",
              "win": {
                "target": [
                  {
                    "target": "nsis",
                    "arch": ["x64"]
                  }
                ],
                "icon": "icon.ico"
              },
              "files": [
                "main.js",
                "preload.js",
                "directus-app/**/*",
                "!directus-app/node_modules/**/{CHANGELOG.md,README.md,README,readme.md,readme}",
                "!directus-app/node_modules/**/{test,__tests__,tests,powered-test,example,examples}",
                "!directus-app/node_modules/**/*.d.ts",
                "!directus-app/node_modules/.bin"
              ],
              "asarUnpack": [
                "directus-app/**/*"
              ],
              "directories": {
                "output": "dist"
              },
              "nsis": {
                "oneClick": false,
                "allowToChangeInstallationDirectory": true,
                "createDesktopShortcut": true,
                "createStartMenuShortcut": true
              }
            }
          }
          EOF

          # åˆ›å»º preload.js
          cat > preload.js << 'EOF'
          const { contextBridge, ipcRenderer } = require('electron');

          contextBridge.exposeInMainWorld('electronAPI', {
            getAppPath: () => ipcRenderer.invoke('get-app-path'),
            openExternal: (url) => ipcRenderer.invoke('open-external', url)
          });
          EOF

          # åˆ›å»º main.js
          cat > main.js << 'EOF'
          const { app, BrowserWindow, ipcMain, shell, dialog } = require('electron');
          const path = require('path');
          const { spawn, execSync } = require('child_process');
          const fs = require('fs');

          let mainWindow;
          let directusProcess;
          const PORT = 8055;
          let startupLogs = [];

          function getDirectusPath() {
            if (app.isPackaged) {
              // æ‰“åŒ…åçš„è·¯å¾„
              return path.join(process.resourcesPath, 'app.asar.unpacked', 'directus-app');
            }
            return path.join(__dirname, 'directus-app');
          }

          function findDirectusCli(directusAppPath, log) {
            // æ›´æ–°è·¯å¾„æœç´¢é¡ºåºï¼Œå°†æ‰¾åˆ°çš„è·¯å¾„æ”¾åœ¨å‰é¢
            const possiblePaths = [
              // Docker é•œåƒä¸­æ‰¾åˆ°çš„è·¯å¾„
              path.join(directusAppPath, 'cli.js'),  // âœ“ è¿™ä¸ªå­˜åœ¨ï¼
              
              // å…¶ä»–å¯èƒ½çš„è·¯å¾„
              path.join(directusAppPath, 'cli', 'index.js'),
              path.join(directusAppPath, 'dist', 'cli.js'),
              path.join(directusAppPath, 'dist', 'index.js'),
              path.join(directusAppPath, 'dist', 'cli', 'index.js'),
              
              // node_modules ä¸­çš„è·¯å¾„ï¼ˆå¤‡ç”¨ï¼‰
              path.join(directusAppPath, 'node_modules', 'directus', 'dist', 'cli', 'index.js'),
              path.join(directusAppPath, 'node_modules', 'directus', 'cli.js'),
              path.join(directusAppPath, 'node_modules', 'directus', 'dist', 'index.js'),
              path.join(directusAppPath, 'node_modules', '.bin', 'directus'),
              
              // å…¶ä»–å¤‡é€‰
              path.join(directusAppPath, 'dist', 'start.js'),
              path.join(directusAppPath, 'api', 'dist', 'index.js'),
              path.join(directusAppPath, 'index.js'),
            ];
            
            let directusCliPath = null;
            for (const p of possiblePaths) {
              log(`Checking: ${p}`);
              if (fs.existsSync(p)) {
                directusCliPath = p;
                log(`âœ“ Found Directus CLI at: ${p}`);
                return directusCliPath;  // æ‰¾åˆ°åç«‹å³è¿”å›
              }
            }
            
            // å¦‚æœä¸Šè¿°éƒ½æ²¡æ‰¾åˆ°ï¼Œå°è¯•æœ‰é™æ·±åº¦çš„æœç´¢
            if (!directusCliPath) {
              log('Standard paths not found, performing limited search...');
              try {
                // åªåœ¨å‰3å±‚ç›®å½•æœç´¢ cli.js
                const searchCmd = process.platform === 'win32' 
                  ? `powershell -Command "Get-ChildItem -Path '${directusAppPath}' -Recurse -Depth 2 -Filter 'cli.js' -File -ErrorAction SilentlyContinue | Select-Object -First 1 -ExpandProperty FullName"`
                  : `find "${directusAppPath}" -maxdepth 3 -name "cli.js" -type f 2>/dev/null | head -1`;
                
                log(`Search command: ${searchCmd}`);
                const result = execSync(searchCmd, { encoding: 'utf8', timeout: 10000 });
                const foundPath = result.trim();
                
                if (foundPath && fs.existsSync(foundPath)) {
                  log(`âœ“ Found via limited search: ${foundPath}`);
                  directusCliPath = foundPath;
                }
              } catch (e) {
                log(`Limited search failed: ${e.message}`);
              }
            }
            
            return directusCliPath;
          }

          function startDirectus() {
            const directusAppPath = getDirectusPath();
            const userDataPath = app.getPath('userData');
            const dbPath = path.join(userDataPath, 'database', 'directus.db');
            const logPath = path.join(userDataPath, 'directus.log');
            
            // åˆ›å»ºæ—¥å¿—æµ
            const logStream = fs.createWriteStream(logPath, { flags: 'a' });
            
            function log(msg) {
              const timestamp = new Date().toISOString();
              const logMsg = `[${timestamp}] ${msg}\n`;
              logStream.write(logMsg);
              console.log(msg);
              startupLogs.push(msg);
            }
            
            log('=== Directus å¯åŠ¨å¼€å§‹ ===');
            log(`App path: ${directusAppPath}`);
            log(`Database path: ${dbPath}`);
            log(`Log path: ${logPath}`);
            log(`Platform: ${process.platform}`);
            log(`Node version: ${process.version}`);
            
            // æ£€æŸ¥ directus-app ç›®å½•æ˜¯å¦å­˜åœ¨
            if (!fs.existsSync(directusAppPath)) {
              log(`ERROR: Directus app directory not found: ${directusAppPath}`);
              log('Available directories:');
              try {
                const parentDir = path.dirname(directusAppPath);
                const items = fs.readdirSync(parentDir);
                items.forEach(item => log(`  - ${item}`));
              } catch (e) {
                log(`Error listing parent directory: ${e.message}`);
              }
              showErrorDialog('ç›®å½•ä¸å­˜åœ¨', `Directus åº”ç”¨ç›®å½•æœªæ‰¾åˆ°:\n${directusAppPath}`);
              return;
            }
            
            log(`âœ“ Directus app directory exists`);
            
            // åˆ—å‡ºç›®å½•å†…å®¹
            log('Directory contents:');
            try {
              const items = fs.readdirSync(directusAppPath);
              items.slice(0, 30).forEach(item => {
                const itemPath = path.join(directusAppPath, item);
                const stats = fs.statSync(itemPath);
                log(`  ${stats.isDirectory() ? '[DIR]' : '[FILE]'} ${item}`);
              });
            } catch (e) {
              log(`Error reading directory: ${e.message}`);
            }
            
            // ç¡®ä¿æ•°æ®åº“ç›®å½•å­˜åœ¨
            const dbDir = path.dirname(dbPath);
            if (!fs.existsSync(dbDir)) {
              fs.mkdirSync(dbDir, { recursive: true });
              log(`Created database directory: ${dbDir}`);
            }
            
            // æŸ¥æ‰¾ Directus CLI
            log('Searching for Directus CLI...');
            const directusCliPath = findDirectusCli(directusAppPath, log);
            
            if (!directusCliPath) {
              log('ERROR: Could not find Directus CLI in any expected location');
              showErrorDialog('æ‰¾ä¸åˆ° Directus CLI', 
                `æ— æ³•æ‰¾åˆ° Directus å…¥å£æ–‡ä»¶ã€‚\n\nè¯·æŸ¥çœ‹æ—¥å¿—: ${logPath}`);
              return;
            }

            // è®¾ç½®ç¯å¢ƒå˜é‡
            const env = {
              ...process.env,
              PORT: PORT.toString(),
              HOST: '0.0.0.0',
              PUBLIC_URL: `http://localhost:${PORT}`,
              
              // æ•°æ®åº“é…ç½® - ä½¿ç”¨ SQLite
              DB_CLIENT: 'sqlite3',
              DB_FILENAME: dbPath,
              
              // å­˜å‚¨é…ç½®
              STORAGE_LOCATIONS: 'local',
              STORAGE_LOCAL_ROOT: path.join(userDataPath, 'uploads'),
              
              // æ‰©å±•é…ç½®
              EXTENSIONS_PATH: path.join(userDataPath, 'extensions'),
              
              // ç®¡ç†å‘˜é…ç½®ï¼ˆé¦–æ¬¡å¯åŠ¨ï¼‰
              ADMIN_EMAIL: 'admin@example.com',
              ADMIN_PASSWORD: 'admin',
              
              // å¯†é’¥
              KEY: 'directus-desktop-key-' + Math.random().toString(36),
              SECRET: 'directus-desktop-secret-' + Math.random().toString(36),
              
              // ç¦ç”¨é¥æµ‹
              TELEMETRY: 'false',
              
              NODE_ENV: 'production',
              
              // æ—¥å¿—çº§åˆ«
              LOG_LEVEL: 'info'
            };

            log(`Environment configured, PORT: ${PORT}`);
            log(`Spawning: "${process.execPath}" "${directusCliPath}" start`);
            log(`Working directory: ${directusAppPath}`);

            // ä½¿ç”¨ node ç›´æ¥è¿è¡Œ Directus CLI
            try {
              directusProcess = spawn(process.execPath, [directusCliPath, 'start'], {
                env: env,
                cwd: directusAppPath,
                stdio: ['ignore', 'pipe', 'pipe']
              });

              log(`âœ“ Process spawned with PID: ${directusProcess.pid}`);

              directusProcess.stdout.on('data', (data) => {
                const msg = data.toString().trim();
                log(`[STDOUT] ${msg}`);
                
                // æ£€æµ‹å¯åŠ¨æˆåŠŸçš„æ ‡å¿—
                if (msg.includes('Server started') || msg.includes('listening') || msg.includes('ready')) {
                  log('âœ“ Directus å¯åŠ¨æˆåŠŸï¼');
                }
              });

              directusProcess.stderr.on('data', (data) => {
                const msg = data.toString().trim();
                // è¿‡æ»¤æ‰æ— å®³çš„è­¦å‘Š
                if (!msg.includes('DeprecationWarning') && 
                    !msg.includes('ExperimentalWarning') &&
                    !msg.includes('punycode')) {
                  log(`[STDERR] ${msg}`);
                }
              });

              directusProcess.on('error', (error) => {
                log(`ERROR: Failed to start process: ${error.message}`);
                log(`Error stack: ${error.stack}`);
                showErrorDialog('å¯åŠ¨å¤±è´¥', error.message);
              });

              directusProcess.on('close', (code) => {
                log(`Process exited with code ${code}`);
                if (code !== 0 && code !== null) {
                  showErrorDialog('è¿›ç¨‹å¼‚å¸¸é€€å‡º', `é€€å‡ºä»£ç : ${code}\n\nè¯·æŸ¥çœ‹æ—¥å¿—: ${logPath}`);
                }
              });
              
              log('Process spawned successfully, waiting for startup...');
            } catch (error) {
              log(`ERROR: Exception during spawn: ${error.message}`);
              log(`Stack: ${error.stack}`);
              showErrorDialog('å¯åŠ¨å¼‚å¸¸', error.message);
            }
          }
          
          function showErrorDialog(title, message) {
            if (mainWindow) {
              dialog.showErrorBox(title, message + '\n\næ—¥å¿—ä½ç½®:\n' + path.join(app.getPath('userData'), 'directus.log'));
            }
          }

          function createWindow() {
            mainWindow = new BrowserWindow({
              width: 1400,
              height: 900,
              webPreferences: {
                nodeIntegration: false,
                contextIsolation: true,
                preload: path.join(__dirname, 'preload.js')
              },
              icon: path.join(__dirname, 'icon.ico'),
              show: false
            });

            // æ˜¾ç¤ºåŠ è½½é¡µé¢
            mainWindow.loadURL(`data:text/html;charset=utf-8,${encodeURIComponent(`
              <html>
                <head>
                  <meta charset="utf-8">
                  <title>Directus å¯åŠ¨ä¸­</title>
                </head>
                <body style="margin:0;padding:0;display:flex;align-items:center;justify-content:center;height:100vh;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);">
                  <div style="text-align:center;color:white;max-width:600px;padding:20px;">
                    <div style="font-size:64px;margin-bottom:20px;">ğŸš€</div>
                    <h1 style="font-size:32px;font-weight:600;margin:0 0 10px 0;">Directus å¯åŠ¨ä¸­</h1>
                    <p style="font-size:16px;opacity:0.9;margin:0 0 30px 0;">é¦–æ¬¡å¯åŠ¨éœ€è¦åˆå§‹åŒ–æ•°æ®åº“ï¼Œè¯·ç¨å€™...</p>
                    <div style="width:300px;height:4px;background:rgba(255,255,255,0.3);border-radius:2px;overflow:hidden;margin:0 auto 20px auto;">
                      <div style="width:100%;height:100%;background:white;animation:slide 1.5s ease-in-out infinite;"></div>
                    </div>
                    <div id="logs" style="margin-top:30px;padding:15px;background:rgba(0,0,0,0.3);border-radius:8px;max-height:200px;overflow-y:auto;text-align:left;font-size:12px;font-family:monospace;line-height:1.6;">
                      <div>æ­£åœ¨åˆå§‹åŒ–...</div>
                    </div>
                    <style>
                      @keyframes slide {
                        0% { transform: translateX(-100%); }
                        50% { transform: translateX(0); }
                        100% { transform: translateX(100%); }
                      }
                    </style>
                  </div>
                </body>
              </html>
            `)}`);

            mainWindow.once('ready-to-show', () => {
              mainWindow.show();
            });

            // ç­‰å¾… Directus å¯åŠ¨
            setTimeout(() => {
              checkDirectusReady();
            }, 15000);

            mainWindow.on('closed', () => {
              mainWindow = null;
            });

            // å¤„ç†å¤–éƒ¨é“¾æ¥
            mainWindow.webContents.setWindowOpenHandler(({ url }) => {
              shell.openExternal(url);
              return { action: 'deny' };
            });
          }

          function checkDirectusReady(attempts = 0) {
            if (attempts > 60) {
              console.error('Directus failed to start after 60 attempts (2 minutes)');
              const logPath = path.join(app.getPath('userData'), 'directus.log');
              showErrorDialog(
                'Directus å¯åŠ¨è¶…æ—¶',
                `å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—æ–‡ä»¶ï¼š\n${logPath}\n\nå¯èƒ½çš„åŸå› ï¼š\n- ç«¯å£ ${PORT} è¢«å ç”¨\n- æ•°æ®åº“æ–‡ä»¶æŸå\n- ç¼ºå°‘å¿…è¦çš„ä¾èµ–`
              );
              return;
            }

            const http = require('http');
            
            const options = {
              hostname: 'localhost',
              port: PORT,
              path: '/server/health',
              method: 'GET',
              timeout: 3000
            };

            const req = http.request(options, (res) => {
              console.log(`Health check status: ${res.statusCode} (attempt ${attempts + 1})`);
              
              if (res.statusCode === 200) {
                console.log('âœ“ Directus is ready!');
                if (mainWindow && !mainWindow.isDestroyed()) {
                  setTimeout(() => {
                    mainWindow.loadURL(`http://localhost:${PORT}/admin`);
                  }, 2000);
                }
              } else {
                setTimeout(() => checkDirectusReady(attempts + 1), 2000);
              }
            });

            req.on('error', (err) => {
              if (attempts % 10 === 0) {
                console.log(`Connection attempt ${attempts + 1}/60: ${err.message}`);
              }
              setTimeout(() => checkDirectusReady(attempts + 1), 2000);
            });

            req.on('timeout', () => {
              req.destroy();
              setTimeout(() => checkDirectusReady(attempts + 1), 2000);
            });

            req.end();
          }

          // IPC handlers
          ipcMain.handle('get-app-path', () => {
            return app.getPath('userData');
          });

          ipcMain.handle('open-external', (event, url) => {
            shell.openExternal(url);
          });

          app.on('ready', () => {
            startDirectus();
            setTimeout(createWindow, 2000);
            
            // æ·»åŠ å¼€å‘è€…å·¥å…·å¿«æ·é”® F12
            const { globalShortcut } = require('electron');
            globalShortcut.register('F12', () => {
              if (mainWindow) {
                mainWindow.webContents.toggleDevTools();
              }
            });
          });

          app.on('window-all-closed', () => {
            if (directusProcess) {
              directusProcess.kill();
            }
            if (process.platform !== 'darwin') {
              app.quit();
            }
          });

          app.on('activate', () => {
            if (mainWindow === null) {
              createWindow();
            }
          });

          app.on('before-quit', () => {
            if (directusProcess) {
              directusProcess.kill('SIGTERM');
              setTimeout(() => {
                if (directusProcess && !directusProcess.killed) {
                  directusProcess.kill('SIGKILL');
                }
              }, 1000);
            }
          });
          EOF

          echo "Electron app structure created"

      - name: Install Electron dependencies
        run: npm install

      - name: Build Electron app
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npm run build

      - name: Get version
        id: version
        shell: bash
        run: |
          if [ "${{ github.ref_type }}" == "tag" ]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION="${{ github.event.inputs.version }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: List build output
        shell: bash
        run: |
          echo "Build output files:"
          ls -lh dist/

      - name: Rename and prepare installer
        shell: bash
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          cd dist
          
          # æ‰¾åˆ°ç”Ÿæˆçš„ exe å®‰è£…åŒ…
          INSTALLER_FILE=$(find . -maxdepth 1 -name "*.exe" -type f | head -n 1)
          
          if [ -n "$INSTALLER_FILE" ]; then
            NEW_NAME="Directus-Desktop-${VERSION}-Windows-x64-Setup.exe"
            mv "$INSTALLER_FILE" "$NEW_NAME"
            echo "âœ… Renamed installer to: $NEW_NAME"
            echo "installer_name=$NEW_NAME" >> $GITHUB_OUTPUT
          else
            echo "âŒ No installer file found!"
            exit 1
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Directus Desktop v${{ steps.version.outputs.version }}
          body: |
            ## ğŸ‰ Directus Desktop v${{ steps.version.outputs.version }}
            
            åŸºäº **Directus 11.5.1** çš„ Windows æ¡Œé¢ç‰ˆæœ¬
            
            ### ğŸ“¥ ä¸‹è½½ä¸å®‰è£…
            
            1. â¬‡ï¸ ä¸‹è½½ `Directus-Desktop-${{ steps.version.outputs.version }}-Windows-x64-Setup.exe`
            2. ğŸ–±ï¸ åŒå‡»è¿è¡Œå®‰è£…ç¨‹åº
            3. â±ï¸ é¦–æ¬¡å¯åŠ¨ç­‰å¾… 10-15 ç§’åˆå§‹åŒ–æ•°æ®åº“
            4. ğŸŠ å¼€å§‹ä½¿ç”¨ï¼
            
            ### ğŸ” é»˜è®¤ç®¡ç†å‘˜è´¦å·
            
            é¦–æ¬¡è®¿é—®æ—¶ä½¿ç”¨ä»¥ä¸‹è´¦å·ç™»å½•ï¼š
            - **é‚®ç®±**ï¼š`admin@example.com`
            - **å¯†ç **ï¼š`admin`
            
            âš ï¸ **é‡è¦**ï¼šç™»å½•åè¯·ç«‹å³ä¿®æ”¹å¯†ç ï¼
            
            ### âœ¨ åŠŸèƒ½ç‰¹æ€§
            
            - âœ… å®Œæ•´çš„ Directus CMS åŠŸèƒ½
            - âœ… å†…ç½® SQLite æ•°æ®åº“ï¼ˆæ— éœ€é¢å¤–é…ç½®ï¼‰
            - âœ… æ•°æ®è‡ªåŠ¨ä¿å­˜åˆ°ç”¨æˆ·ç›®å½•
            - âœ… æ”¯æŒæ–‡ä»¶ä¸Šä¼ å’Œç®¡ç†
            - âœ… å®Œå…¨ç¦»çº¿å¯ç”¨
            - âœ… ä¸€é”®å¯åŠ¨ï¼Œå¼€ç®±å³ç”¨
            
            ### ğŸ“‚ æ•°æ®å­˜å‚¨ä½ç½®
            
            æ‰€æœ‰æ•°æ®ä¿å­˜åœ¨ï¼š
            ```
            C:\Users\<ä½ çš„ç”¨æˆ·å>\AppData\Roaming\directus-desktop\
            â”œâ”€â”€ database\
            â”‚   â””â”€â”€ directus.db      (æ•°æ®åº“æ–‡ä»¶)
            â”œâ”€â”€ uploads\             (ä¸Šä¼ çš„æ–‡ä»¶)
            â””â”€â”€ extensions\          (æ‰©å±•æ’ä»¶)
            ```
            
            ### ğŸ’¡ ä½¿ç”¨æç¤º
            
            - è®¿é—®åœ°å€ï¼š`http://localhost:8055/admin`
            - å¯ä»¥å¤šå¼€ï¼ˆä¼šè‡ªåŠ¨ä½¿ç”¨ä¸åŒç«¯å£ï¼‰
            - å…³é—­çª—å£å³åœæ­¢æœåŠ¡
            - å¸è½½ä¸ä¼šåˆ é™¤æ•°æ®ï¼Œéœ€æ‰‹åŠ¨åˆ é™¤ä¸Šè¿°ç›®å½•
            - æŒ‰ F12 å¯æ‰“å¼€å¼€å‘è€…å·¥å…·
            
            ### ğŸ› é‡åˆ°é—®é¢˜ï¼Ÿ
            
            - å¦‚æœå¯åŠ¨å¤±è´¥ï¼Œæ£€æŸ¥ç«¯å£ 8055 æ˜¯å¦è¢«å ç”¨
            - æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶ï¼š`%APPDATA%\directus-desktop\directus.log`
            - å¦‚æœå¿˜è®°å¯†ç ï¼Œå¯ä»¥åˆ é™¤æ•°æ®åº“æ–‡ä»¶é‡æ–°åˆå§‹åŒ–
            - æ›´å¤šé—®é¢˜è¯·æäº¤ Issue
            
            ---
            
            ğŸ“¦ **æ–‡ä»¶ä¿¡æ¯**
            - ç‰ˆæœ¬ï¼šv${{ steps.version.outputs.version }}
            - Directus ç‰ˆæœ¬ï¼š11.5.1
            - æ¶æ„ï¼šWindows x64
            - å®‰è£…åŒ…å¤§å°ï¼š~150MB
            - å®‰è£…åå¤§å°ï¼š~300MB
          draft: false
          prerelease: false
          files: |
            dist/Directus-Desktop-${{ steps.version.outputs.version }}-Windows-x64-Setup.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
