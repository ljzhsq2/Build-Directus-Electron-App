name: Build Directus Desktop 11.5.1 (NSIS)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 2.0.0)'
        required: true
        default: '2.0.0'

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Download portable Node.js
        shell: pwsh
        run: |
          Write-Host "================================================"
          Write-Host "  Downloading Portable Node.js 20.x"
          Write-Host "================================================"
          Write-Host ""

          $NODE_VERSION = "20.11.0"
          $NODE_URL = "https://nodejs.org/dist/v$NODE_VERSION/node-v$NODE_VERSION-win-x64.zip"

          Write-Host "Downloading from: $NODE_URL"
          Invoke-WebRequest -Uri $NODE_URL -OutFile "node-portable.zip"

          Write-Host "Extracting..."
          Expand-Archive -Path "node-portable.zip" -DestinationPath "." -Force

          Write-Host "Renaming directory..."
          Rename-Item -Path "node-v$NODE_VERSION-win-x64" -NewName "node-portable"

          Write-Host ""
          Write-Host "âœ“ Portable Node.js ready"
          Write-Host "  Location: $(Get-Location)\node-portable"
          Write-Host "  Node version:"
          & .\node-portable\node.exe --version

      - name: Install Directus 11.5.1
        shell: pwsh
        run: |
          Write-Host "================================================"
          Write-Host "  Installing Directus 11.5.1"
          Write-Host "================================================"
          Write-Host ""

          cd directus-app

          Write-Host "Running: npm install --production"
          npm install --production --no-optional

          Write-Host ""
          Write-Host "âœ“ Directus 11.5.1 installed"
          Write-Host ""
          Write-Host "Verification:"

          if (Test-Path "node_modules\directus\cli.js") {
            Write-Host "  âœ“ Directus CLI found"
          } else {
            Write-Host "  âœ— Directus CLI NOT FOUND!"
            exit 1
          }

          Write-Host ""
          Write-Host "Directory size:"
          $size = (Get-ChildItem -Recurse | Measure-Object -Property Length -Sum).Sum / 1MB
          Write-Host "  $([math]::Round($size, 2)) MB"

      - name: Prepare build structure
        shell: pwsh
        run: |
          Write-Host "================================================"
          Write-Host "  Preparing Build Structure"
          Write-Host "================================================"
          Write-Host ""

          # åˆ›å»º runtime ç›®å½•
          New-Item -ItemType Directory -Force -Path "installer\runtime" | Out-Null
          New-Item -ItemType Directory -Force -Path "installer\runtime\directus" | Out-Null

          Write-Host "Copying Node.js runtime..."
          Copy-Item "node-portable\node.exe" "installer\runtime\node.exe"

          Write-Host "Copying Directus files..."
          Copy-Item -Path "directus-app\*" -Destination "installer\runtime\directus" -Recurse -Force

          Write-Host ""
          Write-Host "âœ“ Build structure ready"
          Write-Host ""
          Write-Host "Structure:"
          Get-ChildItem "installer\runtime" | ForEach-Object { Write-Host "  - $($_.Name)" }

      - name: Create default icon
        shell: pwsh
        run: |
          Write-Host "================================================"
          Write-Host "  Creating Icon"
          Write-Host "================================================"
          Write-Host ""

          # æ–¹æ¡ˆ1: å°è¯•ä¸‹è½½ Directus å›¾æ ‡
          try {
            $iconUrl = "https://raw.githubusercontent.com/directus/directus/main/app/public/favicon.ico"
            Write-Host "Downloading Directus favicon..."
            Invoke-WebRequest -Uri $iconUrl -OutFile "installer\icon.ico" -ErrorAction Stop

            $iconSize = (Get-Item "installer\icon.ico").Length
            if ($iconSize -gt 0) {
              Write-Host "âœ“ Icon downloaded successfully ($iconSize bytes)"
              return
            } else {
              Remove-Item "installer\icon.ico" -Force -ErrorAction SilentlyContinue
            }
          } catch {
            Write-Host "âš  Could not download icon: $($_.Exception.Message)"
          }

          # æ–¹æ¡ˆ2: ä½¿ç”¨ PowerShell åˆ›å»ºä¸€ä¸ªç®€å•çš„ ICO æ–‡ä»¶
          Write-Host "Creating a basic icon using PowerShell..."

          # ICO æ–‡ä»¶çš„æœ€å°ç»“æ„ï¼ˆ16x16 å•è‰²å›¾æ ‡ï¼‰
          $iconBytes = @(
            0x00, 0x00,       # Reserved
            0x01, 0x00,       # Type (1 = ICO)
            0x01, 0x00,       # Count (1 image)
            0x10,             # Width (16)
            0x10,             # Height (16)
            0x00,             # Color count (0 = >256)
            0x00,             # Reserved
            0x01, 0x00,       # Color planes
            0x20, 0x00,       # Bits per pixel (32)
            0x68, 0x04, 0x00, 0x00,  # Image size
            0x16, 0x00, 0x00, 0x00   # Image offset
          )

          # æ·»åŠ å›¾åƒæ•°æ®ï¼ˆç®€å•çš„è“è‰²å›¾æ ‡ï¼‰
          $imageData = New-Object byte[] 1128
          for ($i = 0; $i -lt 256; $i++) {
            $imageData[$i*4] = 0xFF     # Blue
            $imageData[$i*4+1] = 0x00   # Green
            $imageData[$i*4+2] = 0x00   # Red
            $imageData[$i*4+3] = 0xFF   # Alpha
          }

          [System.IO.File]::WriteAllBytes("$(Get-Location)\installer\icon.ico", $iconBytes + $imageData)

          Write-Host "âœ“ Basic icon created"

      - name: Install NSIS
        shell: pwsh
        run: |
          Write-Host "================================================"
          Write-Host "  Installing NSIS"
          Write-Host "================================================"
          Write-Host ""

          choco install nsis -y

          # åˆ·æ–°ç¯å¢ƒå˜é‡
          $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")

          Write-Host ""
          Write-Host "âœ“ NSIS installed"
          Write-Host ""

          # æ˜¾ç¤º NSIS ç‰ˆæœ¬
          & "C:\Program Files (x86)\NSIS\makensis.exe" /VERSION

      - name: Get version
        id: version
        shell: pwsh
        run: |
          if ("${{ github.ref_type }}" -eq "tag") {
            $VERSION = "${{ github.ref_name }}".TrimStart("v")
          } else {
            $VERSION = "${{ github.event.inputs.version }}"
          }

          Write-Host "Version: $VERSION"
          "version=$VERSION" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Build installer with NSIS
        shell: pwsh
        run: |
          Write-Host "================================================"
          Write-Host "  Building Installer"
          Write-Host "================================================"
          Write-Host ""

          $VERSION = "${{ steps.version.outputs.version }}"
          Write-Host "Building version: $VERSION"

          cd installer

          # æ›¿æ¢ç‰ˆæœ¬å·
          $nsiContent = Get-Content "installer.nsi" -Raw
          $nsiContent = $nsiContent -replace "VERSION_PLACEHOLDER", $VERSION
          $nsiContent | Set-Content "installer.nsi"

          Write-Host ""
          Write-Host "Running NSIS..."

          # ä½¿ç”¨å®Œæ•´è·¯å¾„è°ƒç”¨ makensis
          $makensis = "C:\Program Files (x86)\NSIS\makensis.exe"
          & $makensis installer.nsi

          Write-Host ""
          Write-Host "âœ“ Installer built successfully"

          # æ˜¾ç¤ºç”Ÿæˆçš„æ–‡ä»¶
          Get-ChildItem "Directus-Desktop-Setup-*.exe" | ForEach-Object {
            $sizeInMB = [math]::Round($_.Length / 1MB, 2)
            Write-Host "  $($_.Name) - $sizeInMB MB"
          }

      - name: Verify installer
        shell: pwsh
        run: |
          Write-Host "================================================"
          Write-Host "  Verifying Installer"
          Write-Host "================================================"
          Write-Host ""

          cd installer

          $installers = Get-ChildItem "Directus-Desktop-Setup-*.exe"

          if ($installers.Count -eq 0) {
            Write-Host "âœ— ERROR: No installer found!"
            exit 1
          }

          foreach ($installer in $installers) {
            Write-Host "âœ“ Found: $($installer.Name)"
            Write-Host "  Size: $([math]::Round($installer.Length / 1MB, 2)) MB"
          }

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Directus Desktop v${{ steps.version.outputs.version }}
          body: |
            ## ğŸ‰ Directus Desktop v${{ steps.version.outputs.version }}

            åŸºäº **Directus 11.5.1** çš„ Windows æ¡Œé¢ç‰ˆï¼ˆNSIS å®‰è£…åŒ…ï¼‰

            ### ğŸ“¥ å®‰è£…

            1. ä¸‹è½½ `Directus-Desktop-Setup-${{ steps.version.outputs.version }}.exe`
            2. åŒå‡»è¿è¡Œå®‰è£…ç¨‹åº
            3. é€‰æ‹©å®‰è£…è·¯å¾„ï¼ˆé»˜è®¤ï¼š`C:\Program Files\Directus Desktop`ï¼‰
            4. å®Œæˆå®‰è£…åï¼ŒåŒå‡»æ¡Œé¢å¿«æ·æ–¹å¼å¯åŠ¨
            5. æµè§ˆå™¨è‡ªåŠ¨æ‰“å¼€ `http://localhost:8055/admin`

            ### ğŸ” é»˜è®¤è´¦å·

            - **é‚®ç®±**: `admin@example.com`
            - **å¯†ç **: `admin`

            âš ï¸ **é¦–æ¬¡ç™»å½•åè¯·ç«‹å³ä¿®æ”¹å¯†ç ï¼**

            ### âœ¨ ç‰¹æ€§

            - âœ… å®Œæ•´çš„ Directus 11.5.1 CMS åŠŸèƒ½
            - âœ… å†…ç½® SQLite æ•°æ®åº“
            - âœ… ä¾¿æºå¼ Node.js è¿è¡Œæ—¶
            - âœ… æ•°æ®å®Œå…¨å¯ç§»æ¤
            - âœ… æ”¯æŒå¤šå®ä¾‹ï¼ˆä¸åŒç«¯å£ï¼‰
            - âœ… æ— éœ€å®‰è£… Node.js æˆ– Docker
            - âœ… ä¸€é”®å¯åŠ¨/åœæ­¢

            ### ğŸ“‚ æ•°æ®ä½ç½®

            ç”¨æˆ·æ•°æ®å­˜å‚¨åœ¨ï¼š
            ```
            C:\Users\<ç”¨æˆ·å>\AppData\Roaming\directus-desktop\
            â”œâ”€â”€ database\directus.db    (æ•°æ®åº“)
            â”œâ”€â”€ uploads\                 (ä¸Šä¼ æ–‡ä»¶)
            â”œâ”€â”€ extensions\              (æ‰©å±•æ’ä»¶)
            â””â”€â”€ directus.log            (æ—¥å¿—)
            ```

            ### ğŸ”„ æ•°æ®è¿ç§»

            **å®Œæ•´è¿ç§»**:
            1. å…³é—­ Directus Desktop
            2. å¤‡ä»½ `%APPDATA%\directus-desktop\` ç›®å½•
            3. åœ¨æ–°ç”µè„‘ä¸Šå®‰è£… Directus Desktop
            4. å…³é—­åº”ç”¨ï¼Œå¤åˆ¶å¤‡ä»½ç›®å½•è¦†ç›–
            5. å¯åŠ¨åº”ç”¨

            **åªè¿ç§»æ•°æ®åº“**:
            ```
            å…³é—­åº”ç”¨ â†’ æ›¿æ¢ database\directus.db â†’ å¯åŠ¨
            ```

            ### ğŸ’¡ ä½¿ç”¨æŠ€å·§

            - **å¯åŠ¨**: åŒå‡»æ¡Œé¢å¿«æ·æ–¹å¼æˆ–å¼€å§‹èœå•ä¸­çš„"Directus Desktop"
            - **åœæ­¢**: å…³é—­å‘½ä»¤è¡Œçª—å£ï¼Œæˆ–è¿è¡Œ"åœæ­¢ Directus"å¿«æ·æ–¹å¼
            - **è®¿é—®**: http://localhost:8055/admin
            - **æ—¥å¿—**: `%APPDATA%\directus-desktop\directus.log`
            - **å¸è½½**: å¯é€‰æ‹©ä¿ç•™æˆ–åˆ é™¤ç”¨æˆ·æ•°æ®

            ### ğŸ†• æœ¬ç‰ˆæœ¬æ”¹è¿›

            - âœ… å®Œå…¨é‡æ„ï¼šä¸å†ä½¿ç”¨ Electron
            - âœ… ä½¿ç”¨ NSIS å®‰è£…åŒ… + ä¾¿æºå¼ Node.js
            - âœ… é¿å…äº†æ‰€æœ‰ ES Module å’Œå•å®ä¾‹æ£€æµ‹é—®é¢˜
            - âœ… å®‰è£…åŒ…ä½“ç§¯æ›´å°ï¼ˆ~100MBï¼‰
            - âœ… å¯åŠ¨é€Ÿåº¦æ›´å¿«
            - âœ… æ•°æ®ç›®å½•å®Œå…¨ç‹¬ç«‹ï¼Œæ˜“äºå¤‡ä»½å’Œè¿ç§»

            ---

            **ç‰ˆæœ¬ä¿¡æ¯**
            - Directus: 11.5.1
            - Node.js: 20.11.0 (ä¾¿æºç‰ˆ)
            - å®‰è£…æ–¹å¼: NSIS
            - æ”¯æŒç³»ç»Ÿ: Windows 7/8/10/11 (x64)

          draft: false
          prerelease: false
          files: |
            installer/Directus-Desktop-Setup-${{ steps.version.outputs.version }}.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
