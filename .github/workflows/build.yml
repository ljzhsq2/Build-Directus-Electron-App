name: Build Directus Electron App

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

# æ·»åŠ æƒé™é…ç½®
permissions:
  contents: write  # å…è®¸åˆ›å»º Release å’Œä¸Šä¼ æ–‡ä»¶

jobs:
  extract-directus:
    runs-on: ubuntu-latest
    
    steps:
      - name: Extract Directus from Docker
        run: |
          echo "=== Step 1: Pull Docker Image ==="
          docker pull directus/directus:11.5.1
          
          echo ""
          echo "=== Step 2: Create Container and Extract Files ==="
          docker create --name directus-temp directus/directus:11.5.1
          
          # åˆ›å»ºç›®æ ‡ç›®å½•
          mkdir -p directus-app
          
          # æå– Directus æ–‡ä»¶
          docker cp directus-temp:/directus/. ./directus-app/
          docker rm directus-temp
          
          echo ""
          echo "=== Step 3: Verify Extracted Files ==="
          ls -la directus-app/
          echo ""
          echo "=== Looking for CLI Entry Points ==="
          find directus-app -name "cli.js" -o -name "index.js" -type f | head -20
          echo ""
          
          # æ£€æŸ¥å…³é”®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ -f "directus-app/cli.js" ]; then
            echo "âœ“ Found: directus-app/cli.js"
          elif [ -f "directus-app/dist/cli.js" ]; then
            echo "âœ“ Found: directus-app/dist/cli.js"
          elif [ -f "directus-app/dist/index.js" ]; then
            echo "âœ“ Found: directus-app/dist/index.js"
          else
            echo "âš ï¸  Warning: No obvious CLI entry point found"
            echo "Directory structure:"
            tree -L 2 directus-app/ || find directus-app -maxdepth 2 -type f | head -30
          fi
          
          echo ""
          echo "=== Step 4: Resolve Symlinks ==="
          cd directus-app
          
          # æŸ¥æ‰¾å¹¶è§£å†³ç¬¦å·é“¾æ¥
          SYMLINK_COUNT=$(find . -type l | wc -l)
          echo "Found $SYMLINK_COUNT symlinks to resolve"
          
          find . -type l | while read link; do
            target=$(readlink "$link")
            # å¦‚æœç›®æ ‡å­˜åœ¨ï¼Œå¤åˆ¶å®é™…æ–‡ä»¶
            if [ -e "$target" ]; then
              echo "Resolving: $link -> $target"
              rm "$link"
              cp -rL "$target" "$link" 2>/dev/null || echo "Skipped: $link"
            else
              echo "Broken link (removing): $link"
              rm "$link"
            fi
          done
          
          cd ..
          
          echo ""
          echo "=== Step 5: Package Files ==="
          # æ‰“åŒ…ï¼ˆ--dereference è‡ªåŠ¨è§£å¼•ç”¨ç¬¦å·é“¾æ¥ï¼‰
          tar --dereference -czf directus-files.tar.gz directus-app
          
          # æ˜¾ç¤ºæ‰“åŒ…ç»“æœ
          ls -lh directus-files.tar.gz
          echo ""
          echo "âœ… Directus files extracted, processed, and packaged successfully"
      
      - name: Upload Directus files
        uses: actions/upload-artifact@v4
        with:
          name: directus-files
          path: directus-files.tar.gz
          retention-days: 1

  build-windows:
    needs: extract-directus
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: '**/package.json'

      - name: Download Directus files
        uses: actions/download-artifact@v4
        with:
          name: directus-files

      - name: Extract Directus files
        shell: bash
        run: |
          echo "=== Step 1: Verify Downloaded Archive ==="
          ls -lh directus-files.tar.gz
          
          echo ""
          echo "=== Step 2: Extract Archive ==="
          tar -xzf directus-files.tar.gz
          
          echo ""
          echo "=== Step 3: Verify Extracted Directory ==="
          if [ -d "directus-app" ]; then
            echo "âœ“ directus-app directory exists"
            echo ""
            echo "Directory contents (top 30 items):"
            ls -la directus-app/ | head -30
            
            echo ""
            echo "Looking for CLI files:"
            find directus-app -name "cli.js" -o -name "index.js" -type f | head -10
          else
            echo "âŒ ERROR: directus-app directory not found!"
            echo "Available directories:"
            ls -la
            exit 1
          fi
          
          echo ""
          echo "=== Step 4: Check Key Files ==="
          KEY_FILES=(
            "directus-app/cli.js"
            "directus-app/dist/cli.js"
            "directus-app/dist/index.js"
            "directus-app/package.json"
          )
          
          for file in "${KEY_FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ“ Found: $file"
            else
              echo "âœ— Missing: $file"
            fi
          done
          
          echo ""
          echo "âœ… Directus files extracted successfully"

      - name: Create Electron app structure
        shell: bash
        run: |
          echo "=== Creating Electron App Structure ==="

          # è·å–ç‰ˆæœ¬å·
          VERSION="${{ github.event.inputs.version || '1.0.0' }}"

          # åˆ›å»º package.json
          cat > package.json << EOF
{
  "name": "directus-desktop",
  "version": "${VERSION}",
  "description": "Directus Desktop Application for Windows",
  "main": "main.js",
  "scripts": {
    "start": "electron .",
    "build": "electron-builder --win --x64"
  },
  "author": "Directus Desktop",
  "license": "MIT",
  "devDependencies": {
    "electron": "^28.0.0",
    "electron-builder": "^24.9.1"
  },
  "build": {
    "appId": "com.directus.desktop",
    "productName": "Directus",
    "win": {
      "target": [
        {
          "target": "nsis",
          "arch": ["x64"]
        }
      ]
    },
    "files": [
      "main.js",
      "preload.js",
      "directus-app/**/*",
      "!directus-app/node_modules/**/{CHANGELOG.md,README.md,README,readme.md,readme}",
      "!directus-app/node_modules/**/{test,__tests__,tests,powered-test,example,examples}",
      "!directus-app/node_modules/**/*.d.ts",
      "!directus-app/node_modules/.bin",
      "!directus-app/**/.git"
    ],
    "asarUnpack": [
      "directus-app/**/*"
    ],
    "directories": {
      "output": "dist"
    },
    "nsis": {
      "oneClick": false,
      "allowToChangeInstallationDirectory": true,
      "createDesktopShortcut": true,
      "createStartMenuShortcut": true
    }
  }
}
EOF

          echo "âœ“ package.json created"

          # åˆ›å»º preload.js
          cat > preload.js << 'EOF'
const { contextBridge, ipcRenderer } = require('electron');

contextBridge.exposeInMainWorld('electronAPI', {
  getAppPath: () => ipcRenderer.invoke('get-app-path'),
  openExternal: (url) => ipcRenderer.invoke('open-external', url),
  getStartupLogs: () => ipcRenderer.invoke('get-startup-logs')
});
EOF

          echo "âœ“ preload.js created"

          # åˆ›å»º main.js
          cat > main.js << 'EOF'
const { app, BrowserWindow, ipcMain, shell, dialog } = require('electron');
const path = require('path');
const { spawn } = require('child_process');
const fs = require('fs');

let mainWindow;
let directusProcess;
const PORT = 8055;
let startupLogs = [];

function log(msg) {
  const timestamp = new Date().toISOString();
  const logMsg = `[${timestamp}] ${msg}`;
  console.log(logMsg);
  startupLogs.push(logMsg);
  
  // å†™å…¥æ—¥å¿—æ–‡ä»¶
  const logPath = path.join(app.getPath('userData'), 'directus.log');
  try {
    fs.appendFileSync(logPath, logMsg + '\n');
  } catch (e) {
    console.error('Failed to write log:', e);
  }
}

function getDirectusPath() {
  let directusPath;
  
  if (app.isPackaged) {
    // æ‰“åŒ…åçš„è·¯å¾„ - åœ¨ app.asar.unpacked ä¸­
    directusPath = path.join(process.resourcesPath, 'app.asar.unpacked', 'directus-app');
    log(`Packaged mode: checking ${directusPath}`);
  } else {
    // å¼€å‘æ¨¡å¼
    directusPath = path.join(__dirname, 'directus-app');
    log(`Development mode: checking ${directusPath}`);
  }
  
  // éªŒè¯è·¯å¾„æ˜¯å¦å­˜åœ¨
  if (!fs.existsSync(directusPath)) {
    log(`ERROR: Directus path does not exist: ${directusPath}`);
    
    // å°è¯•å¤‡ç”¨è·¯å¾„
    const alternativePaths = [
      path.join(process.resourcesPath, 'directus-app'),
      path.join(app.getAppPath(), 'directus-app'),
      path.join(__dirname, 'directus-app')
    ];
    
    for (const altPath of alternativePaths) {
      log(`Trying alternative path: ${altPath}`);
      if (fs.existsSync(altPath)) {
        log(`âœ“ Found Directus at: ${altPath}`);
        directusPath = altPath;
        break;
      }
    }
    
    // å¦‚æœæ‰€æœ‰è·¯å¾„éƒ½ä¸å­˜åœ¨ï¼Œåˆ—å‡º resources ç›®å½•å†…å®¹
    if (!fs.existsSync(directusPath)) {
      log('Listing process.resourcesPath contents:');
      try {
        const items = fs.readdirSync(process.resourcesPath);
        items.forEach(item => log(`  - ${item}`));
        
        if (fs.existsSync(path.join(process.resourcesPath, 'app.asar.unpacked'))) {
          log('Listing app.asar.unpacked contents:');
          const unpackedItems = fs.readdirSync(path.join(process.resourcesPath, 'app.asar.unpacked'));
          unpackedItems.forEach(item => log(`  - ${item}`));
        }
      } catch (e) {
        log(`Error listing directories: ${e.message}`);
      }
    }
  } else {
    log(`âœ“ Directus path exists: ${directusPath}`);
  }
  
  return directusPath;
}

function findDirectusCLI(directusAppPath) {
  // å¯èƒ½çš„ CLI è·¯å¾„ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰
  const possiblePaths = [
    path.join(directusAppPath, 'cli.js'),
    path.join(directusAppPath, 'dist', 'cli.js'),
    path.join(directusAppPath, 'dist', 'cli', 'index.js'),
    path.join(directusAppPath, 'dist', 'index.js'),
    path.join(directusAppPath, 'node_modules', 'directus', 'dist', 'cli', 'index.js'),
    path.join(directusAppPath, 'node_modules', '.bin', 'directus'),
  ];
  
  log('Searching for Directus CLI...');
  for (const cliPath of possiblePaths) {
    log(`  Checking: ${cliPath}`);
    if (fs.existsSync(cliPath)) {
      log(`  âœ“ Found CLI at: ${cliPath}`);
      return cliPath;
    }
  }
  
  // æ²¡æ‰¾åˆ°ï¼Œåˆ—å‡ºç›®å½•ç»“æ„å¸®åŠ©è¯Šæ–­
  log('ERROR: Could not find Directus CLI in any expected location');
  log('Directory contents:');
  try {
    const items = fs.readdirSync(directusAppPath);
    items.slice(0, 30).forEach(item => {
      const fullPath = path.join(directusAppPath, item);
      const stats = fs.statSync(fullPath);
      const type = stats.isDirectory() ? 'DIR' : 'FILE';
      log(`  [${type}] ${item}`);
    });
    
    // å¦‚æœæœ‰ dist ç›®å½•ï¼Œä¹Ÿåˆ—å‡ºå…¶å†…å®¹
    const distPath = path.join(directusAppPath, 'dist');
    if (fs.existsSync(distPath)) {
      log('Contents of dist/ directory:');
      const distItems = fs.readdirSync(distPath);
      distItems.slice(0, 20).forEach(item => {
        log(`  - ${item}`);
      });
    }
  } catch (e) {
    log(`Error reading directory: ${e.message}`);
  }
  
  return null;
}

function startDirectus() {
  const directusAppPath = getDirectusPath();
  
  if (!fs.existsSync(directusAppPath)) {
    showErrorDialog(
      'æ‰¾ä¸åˆ° Directus æ–‡ä»¶',
      `Directus åº”ç”¨ç›®å½•ä¸å­˜åœ¨ï¼š\n${directusAppPath}\n\nè¿™å¯èƒ½æ˜¯æ‰“åŒ…é…ç½®é—®é¢˜ã€‚\n\nè¯·æŸ¥çœ‹æ—¥å¿—ï¼š\n${path.join(app.getPath('userData'), 'directus.log')}`
    );
    return;
  }
  
  const directusCliPath = findDirectusCLI(directusAppPath);
  
  if (!directusCliPath) {
    showErrorDialog(
      'æ‰¾ä¸åˆ° Directus CLI',
      `æ— æ³•åœ¨ä»¥ä¸‹ç›®å½•ä¸­æ‰¾åˆ° Directus CLIï¼š\n${directusAppPath}\n\nè¯·æŸ¥çœ‹æ—¥å¿—ï¼š\n${path.join(app.getPath('userData'), 'directus.log')}`
    );
    return;
  }
  
  const userDataPath = app.getPath('userData');
  const dbPath = path.join(userDataPath, 'database', 'directus.db');
  const logPath = path.join(userDataPath, 'directus.log');
  
  log('=== Directus å¯åŠ¨é…ç½® ===');
  log(`App path: ${directusAppPath}`);
  log(`CLI path: ${directusCliPath}`);
  log(`Database path: ${dbPath}`);
  log(`Log path: ${logPath}`);
  
  // ç¡®ä¿æ•°æ®åº“ç›®å½•å­˜åœ¨
  const dbDir = path.dirname(dbPath);
  if (!fs.existsSync(dbDir)) {
    fs.mkdirSync(dbDir, { recursive: true });
    log(`Created database directory: ${dbDir}`);
  }
  
  // è®¾ç½®ç¯å¢ƒå˜é‡
  const env = {
    ...process.env,
    PORT: PORT.toString(),
    HOST: '0.0.0.0',
    PUBLIC_URL: `http://localhost:${PORT}`,
    
    // æ•°æ®åº“é…ç½®
    DB_CLIENT: 'sqlite3',
    DB_FILENAME: dbPath,
    
    // å­˜å‚¨é…ç½®
    STORAGE_LOCATIONS: 'local',
    STORAGE_LOCAL_ROOT: path.join(userDataPath, 'uploads'),
    
    // æ‰©å±•é…ç½®
    EXTENSIONS_PATH: path.join(userDataPath, 'extensions'),
    
    // ç®¡ç†å‘˜é…ç½®
    ADMIN_EMAIL: 'admin@example.com',
    ADMIN_PASSWORD: 'admin',
    
    // å¯†é’¥
    KEY: 'directus-desktop-key-' + Math.random().toString(36),
    SECRET: 'directus-desktop-secret-' + Math.random().toString(36),
    
    // ç¦ç”¨é¥æµ‹
    TELEMETRY: 'false',
    
    NODE_ENV: 'production',
    LOG_LEVEL: 'info'
  };

  log(`Starting Directus: node "${directusCliPath}" start`);
  log(`Working directory: ${directusAppPath}`);

  directusProcess = spawn(process.execPath, [directusCliPath, 'start'], {
    env: env,
    cwd: directusAppPath,
    stdio: ['ignore', 'pipe', 'pipe']
  });

  directusProcess.stdout.on('data', (data) => {
    const msg = data.toString().trim();
    log(`[STDOUT] ${msg}`);
  });

  directusProcess.stderr.on('data', (data) => {
    const msg = data.toString().trim();
    if (!msg.includes('DeprecationWarning') && 
        !msg.includes('ExperimentalWarning') &&
        !msg.includes('punycode')) {
      log(`[STDERR] ${msg}`);
    }
  });

  directusProcess.on('error', (error) => {
    log(`ERROR: Failed to start process: ${error.message}`);
    showErrorDialog('å¯åŠ¨å¤±è´¥', error.message);
  });

  directusProcess.on('close', (code) => {
    log(`Process exited with code ${code}`);
    if (code !== 0 && code !== null) {
      showErrorDialog('è¿›ç¨‹å¼‚å¸¸é€€å‡º', `é€€å‡ºä»£ç : ${code}`);
    }
  });
  
  log('âœ“ Process spawned successfully');
}

function showErrorDialog(title, message) {
  const logPath = path.join(app.getPath('userData'), 'directus.log');
  dialog.showErrorBox(
    title,
    message + '\n\næ—¥å¿—ä½ç½®:\n' + logPath
  );
}

function createWindow() {
  const iconPath = path.join(__dirname, 'icon.ico');
  const windowOptions = {
    width: 1400,
    height: 900,
    webPreferences: {
      nodeIntegration: false,
      contextIsolation: true,
      preload: path.join(__dirname, 'preload.js')
    },
    show: false
  };

  // åªæœ‰åœ¨å›¾æ ‡æ–‡ä»¶å­˜åœ¨æ—¶æ‰è®¾ç½®
  if (fs.existsSync(iconPath)) {
    windowOptions.icon = iconPath;
  }

  mainWindow = new BrowserWindow(windowOptions);

  mainWindow.loadURL(`data:text/html;charset=utf-8,${encodeURIComponent(`
    <!DOCTYPE html>
    <html>
      <head>
        <meta charset="utf-8">
        <title>Directus å¯åŠ¨ä¸­</title>
      </head>
      <body style="margin:0;padding:0;display:flex;align-items:center;justify-content:center;height:100vh;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);">
        <div style="text-align:center;color:white;max-width:600px;padding:20px;">
          <div style="font-size:64px;margin-bottom:20px;">ğŸš€</div>
          <h1 style="font-size:32px;font-weight:600;margin:0 0 10px 0;">Directus å¯åŠ¨ä¸­</h1>
          <p style="font-size:16px;opacity:0.9;margin:0 0 30px 0;">é¦–æ¬¡å¯åŠ¨éœ€è¦åˆå§‹åŒ–æ•°æ®åº“ï¼Œè¯·ç¨å€™...</p>
          <div style="width:300px;height:4px;background:rgba(255,255,255,0.3);border-radius:2px;overflow:hidden;margin:0 auto 20px auto;">
            <div style="width:100%;height:100%;background:white;animation:slide 1.5s ease-in-out infinite;"></div>
          </div>
          <div id="logs" style="margin-top:30px;padding:15px;background:rgba(0,0,0,0.3);border-radius:8px;max-height:300px;overflow-y:auto;text-align:left;font-size:11px;font-family:monospace;line-height:1.6;">
            <div>æ­£åœ¨åˆå§‹åŒ–...</div>
          </div>
          <button onclick="showLogs()" style="margin-top:20px;padding:10px 20px;background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.3);color:white;border-radius:5px;cursor:pointer;font-size:14px;">
            æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
          </button>
          <style>
            @keyframes slide {
              0% { transform: translateX(-100%); }
              50% { transform: translateX(0); }
              100% { transform: translateX(100%); }
            }
            button:hover {
              background:rgba(255,255,255,0.3);
            }
          </style>
          <script>
            let updateInterval;
            window.addEventListener('load', function() {
              updateLogs();
              updateInterval = setInterval(updateLogs, 2000);
            });
            
            async function updateLogs() {
              if (window.electronAPI) {
                const logs = await window.electronAPI.getStartupLogs();
                const logsDiv = document.getElementById('logs');
                logsDiv.innerHTML = logs.slice(-20).map(l => '<div>' + l + '</div>').join('');
                logsDiv.scrollTop = logsDiv.scrollHeight;
              }
            }
            
            function showLogs() {
              if (window.electronAPI) {
                const userDataPath = window.electronAPI.getAppPath();
                alert('æ—¥å¿—æ–‡ä»¶ä½ç½®: ' + userDataPath + '/directus.log');
              }
            }
          </script>
        </div>
      </body>
    </html>
  `)}`);

  mainWindow.once('ready-to-show', () => {
    mainWindow.show();
  });

  setTimeout(() => {
    checkDirectusReady();
  }, 15000);

  mainWindow.on('closed', () => {
    mainWindow = null;
  });

  mainWindow.webContents.setWindowOpenHandler(({ url }) => {
    shell.openExternal(url);
    return { action: 'deny' };
  });
}

function checkDirectusReady(attempts = 0) {
  if (attempts > 60) {
    log('ERROR: Directus failed to start after 60 attempts (2 minutes)');
    const logPath = path.join(app.getPath('userData'), 'directus.log');
    showErrorDialog(
      'Directus å¯åŠ¨è¶…æ—¶',
      `å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—æ–‡ä»¶ï¼š\n${logPath}`
    );
    return;
  }

  const http = require('http');
  
  const options = {
    hostname: 'localhost',
    port: PORT,
    path: '/server/health',
    method: 'GET',
    timeout: 3000
  };

  const req = http.request(options, (res) => {
    if (res.statusCode === 200) {
      log(`âœ“ Directus is ready! (attempt ${attempts + 1})`);
      if (mainWindow && !mainWindow.isDestroyed()) {
        setTimeout(() => {
          mainWindow.loadURL(`http://localhost:${PORT}/admin`);
        }, 2000);
      }
    } else {
      setTimeout(() => checkDirectusReady(attempts + 1), 2000);
    }
  });

  req.on('error', (err) => {
    if (attempts % 10 === 0) {
      log(`Connection attempt ${attempts + 1}/60: ${err.message}`);
    }
    setTimeout(() => checkDirectusReady(attempts + 1), 2000);
  });

  req.on('timeout', () => {
    req.destroy();
    setTimeout(() => checkDirectusReady(attempts + 1), 2000);
  });

  req.end();
}

// IPC handlers
ipcMain.handle('get-app-path', () => {
  return app.getPath('userData');
});

ipcMain.handle('open-external', (event, url) => {
  shell.openExternal(url);
});

ipcMain.handle('get-startup-logs', () => {
  return startupLogs;
});

app.on('ready', () => {
  log('=== Application Starting ===');
  log(`App version: ${app.getVersion()}`);
  log(`Electron version: ${process.versions.electron}`);
  log(`Node version: ${process.versions.node}`);
  log(`Platform: ${process.platform}`);
  log(`Is packaged: ${app.isPackaged}`);
  log(`App path: ${app.getAppPath()}`);
  log(`Resources path: ${process.resourcesPath}`);
  log(`User data: ${app.getPath('userData')}`);
  
  startDirectus();
  setTimeout(createWindow, 2000);
  
  const { globalShortcut } = require('electron');
  globalShortcut.register('F12', () => {
    if (mainWindow) {
      mainWindow.webContents.toggleDevTools();
    }
  });
});

app.on('window-all-closed', () => {
  if (directusProcess) {
    directusProcess.kill();
  }
  if (process.platform !== 'darwin') {
    app.quit();
  }
});

app.on('activate', () => {
  if (mainWindow === null) {
    createWindow();
  }
});

app.on('before-quit', () => {
  if (directusProcess) {
    directusProcess.kill('SIGTERM');
    setTimeout(() => {
      if (directusProcess && !directusProcess.killed) {
        directusProcess.kill('SIGKILL');
      }
    }, 1000);
  }
});
EOF

          echo "âœ“ main.js created"

          echo ""
          echo "âœ… Electron app structure created successfully"

      - name: Create default icon
        shell: pwsh
        run: |
          Write-Host "=== Creating default icon ==="
          # åœ¨ Windows ä¸Š,æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ PowerShell åˆ›å»ºä¸€ä¸ªåŸºæœ¬çš„ ICO æ–‡ä»¶
          # æˆ–è€…ä»é¡¹ç›®ä¸­å¤åˆ¶,å¦‚æœä¸å­˜åœ¨åˆ™ electron-builder ä½¿ç”¨é»˜è®¤å›¾æ ‡

          # æ£€æŸ¥æ˜¯å¦æœ‰å›¾æ ‡æ–‡ä»¶åœ¨ä»“åº“ä¸­
          if (Test-Path "icon.ico") {
            Write-Host "âœ“ icon.ico already exists in repository"
          } elseif (Test-Path "assets/icon.ico") {
            Copy-Item "assets/icon.ico" "icon.ico"
            Write-Host "âœ“ Copied icon.ico from assets/"
          } else {
            Write-Host "âš ï¸ No icon.ico found. Electron-builder will use default Electron icon."
            Write-Host "   To use a custom icon, add icon.ico to the repository root or assets/ folder"
          }

      - name: Verify directus-app before build
        shell: bash
        run: |
          echo "=== Final Verification Before Build ==="
          echo ""
          echo "Checking directus-app directory:"
          if [ -d "directus-app" ]; then
            echo "âœ“ directus-app exists"
            echo ""
            echo "Size:"
            du -sh directus-app
            echo ""
            echo "Top-level contents:"
            ls -la directus-app/ | head -20
            echo ""
            echo "Looking for CLI:"
            find directus-app -name "cli.js" -o -name "index.js" -type f | head -10
          else
            echo "âŒ ERROR: directus-app not found!"
            ls -la
            exit 1
          fi
          
          echo ""
          echo "Checking package.json build config:"
          if [ -f "package.json" ]; then
            echo "âœ“ package.json exists"
            grep -A 5 '"files"' package.json || echo "No files section found"
            grep -A 3 '"asarUnpack"' package.json || echo "No asarUnpack section found"
          else
            echo "âŒ ERROR: package.json not found!"
            exit 1
          fi

      - name: Install Electron dependencies
        run: npm install

      - name: Build Electron app
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npm run build

      - name: Verify build output
        shell: bash
        run: |
          echo "=== Build Output Verification ==="
          echo ""
          echo "dist/ contents:"
          ls -lh dist/
          echo ""
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å¯æ‰§è¡Œæ–‡ä»¶
          EXE_COUNT=$(find dist -name "*.exe" -type f | wc -l)
          echo "Found $EXE_COUNT .exe file(s)"
          
          if [ $EXE_COUNT -eq 0 ]; then
            echo "âŒ ERROR: No .exe installer found!"
            echo ""
            echo "Looking for other files:"
            find dist -type f
            exit 1
          fi
          
          echo ""
          echo "âœ… Build verification passed"

      - name: Get version
        id: version
        shell: bash
        run: |
          if [ "${{ github.ref_type }}" == "tag" ]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION="${{ github.event.inputs.version }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Rename and prepare installer
        id: prepare
        shell: bash
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          cd dist
          
          # æ‰¾åˆ°ç”Ÿæˆçš„ exe å®‰è£…åŒ…
          INSTALLER_FILE=$(find . -maxdepth 1 -name "*.exe" -type f | head -n 1)
          
          if [ -n "$INSTALLER_FILE" ]; then
            NEW_NAME="Directus-Desktop-${VERSION}-Windows-x64-Setup.exe"
            mv "$INSTALLER_FILE" "$NEW_NAME"
            echo "âœ… Renamed installer to: $NEW_NAME"
            echo "installer_name=$NEW_NAME" >> $GITHUB_OUTPUT
          else
            echo "âŒ No installer file found!"
            exit 1
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Directus Desktop v${{ steps.version.outputs.version }}
          body: |
            ## ğŸ‰ Directus Desktop v${{ steps.version.outputs.version }}
            
            åŸºäº **Directus 11.5.1** çš„ Windows æ¡Œé¢ç‰ˆæœ¬
            
            ### ğŸ“¥ ä¸‹è½½ä¸å®‰è£…
            
            1. â¬‡ï¸ ä¸‹è½½ `Directus-Desktop-${{ steps.version.outputs.version }}-Windows-x64-Setup.exe`
            2. ğŸ–±ï¸ åŒå‡»è¿è¡Œå®‰è£…ç¨‹åº
            3. â±ï¸ é¦–æ¬¡å¯åŠ¨ç­‰å¾… 10-15 ç§’åˆå§‹åŒ–æ•°æ®åº“
            4. ğŸŠ å¼€å§‹ä½¿ç”¨ï¼
            
            ### ğŸ” é»˜è®¤ç®¡ç†å‘˜è´¦å·
            
            é¦–æ¬¡è®¿é—®æ—¶ä½¿ç”¨ä»¥ä¸‹è´¦å·ç™»å½•ï¼š
            - **é‚®ç®±**ï¼š`admin@example.com`
            - **å¯†ç **ï¼š`admin`
            
            âš ï¸ **é‡è¦**ï¼šç™»å½•åè¯·ç«‹å³ä¿®æ”¹å¯†ç ï¼
            
            ### âœ¨ åŠŸèƒ½ç‰¹æ€§
            
            - âœ… å®Œæ•´çš„ Directus CMS åŠŸèƒ½
            - âœ… å†…ç½® SQLite æ•°æ®åº“ï¼ˆæ— éœ€é¢å¤–é…ç½®ï¼‰
            - âœ… æ•°æ®è‡ªåŠ¨ä¿å­˜åˆ°ç”¨æˆ·ç›®å½•
            - âœ… æ”¯æŒæ–‡ä»¶ä¸Šä¼ å’Œç®¡ç†
            - âœ… å®Œå…¨ç¦»çº¿å¯ç”¨
            - âœ… ä¸€é”®å¯åŠ¨ï¼Œå¼€ç®±å³ç”¨
            - âœ… è¯¦ç»†çš„å¯åŠ¨æ—¥å¿—ï¼ˆæŒ‰ F12 æŸ¥çœ‹å®æ—¶æ—¥å¿—ï¼‰
            
            ### ğŸ“‚ æ•°æ®å­˜å‚¨ä½ç½®
            
            æ‰€æœ‰æ•°æ®ä¿å­˜åœ¨ï¼š
            ```
            C:\Users\<ä½ çš„ç”¨æˆ·å>\AppData\Roaming\directus-desktop\
            â”œâ”€â”€ database\
            â”‚   â””â”€â”€ directus.db      (æ•°æ®åº“æ–‡ä»¶)
            â”œâ”€â”€ uploads\             (ä¸Šä¼ çš„æ–‡ä»¶)
            â”œâ”€â”€ extensions\          (æ‰©å±•æ’ä»¶)
            â””â”€â”€ directus.log         (å¯åŠ¨æ—¥å¿—)
            ```
            
            ### ğŸ’¡ ä½¿ç”¨æç¤º
            
            - è®¿é—®åœ°å€ï¼š`http://localhost:8055/admin`
            - å¯åŠ¨æ—¶ä¼šæ˜¾ç¤ºå®æ—¶æ—¥å¿—ï¼Œæ–¹ä¾¿æ’æŸ¥é—®é¢˜
            - æŒ‰ F12 å¯ä»¥æ‰“å¼€å¼€å‘è€…å·¥å…·æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
            - å…³é—­çª—å£å³åœæ­¢æœåŠ¡
            - å¸è½½ä¸ä¼šåˆ é™¤æ•°æ®ï¼Œéœ€æ‰‹åŠ¨åˆ é™¤ä¸Šè¿°ç›®å½•
            
            ### ğŸ› é‡åˆ°é—®é¢˜ï¼Ÿ
            
            1. **æŸ¥çœ‹æ—¥å¿—**ï¼š`C:\Users\<ç”¨æˆ·å>\AppData\Roaming\directus-desktop\directus.log`
            2. **ç«¯å£å ç”¨**ï¼šç¡®ä¿ 8055 ç«¯å£æœªè¢«å ç”¨
            3. **é‡ç½®æ•°æ®**ï¼šåˆ é™¤ `directus.db` æ–‡ä»¶é‡æ–°åˆå§‹åŒ–
            4. **æäº¤ Issue**ï¼šé™„ä¸Šæ—¥å¿—æ–‡ä»¶å†…å®¹
            
            ### ğŸ”§ æœ¬æ¬¡æ›´æ–°
            
            - âœ… ä¿®å¤äº† Docker æ–‡ä»¶æå–å’Œæ‰“åŒ…é—®é¢˜
            - âœ… ä¼˜åŒ–äº†è·¯å¾„æŸ¥æ‰¾é€»è¾‘ï¼Œæ”¯æŒå¤šç§ CLI ä½ç½®
            - âœ… æ·»åŠ äº†è¯¦ç»†çš„å¯åŠ¨æ—¥å¿—å’Œé”™è¯¯æç¤º
            - âœ… æ”¹è¿›äº† electron-builder é…ç½®ï¼Œç¡®ä¿æ–‡ä»¶æ­£ç¡®æ‰“åŒ…
            - âœ… åŠ å¼ºäº†ç›®å½•éªŒè¯å’Œé”™è¯¯å¤„ç†
            
            ---
            
            ğŸ“¦ **æ–‡ä»¶ä¿¡æ¯**
            - ç‰ˆæœ¬ï¼šv${{ steps.version.outputs.version }}
            - Directus ç‰ˆæœ¬ï¼š11.5.1
            - æ¶æ„ï¼šWindows x64
            - å®‰è£…åŒ…å¤§å°ï¼š~150MB
            - å®‰è£…åå¤§å°ï¼š~300MB
          draft: false
          prerelease: false
          files: |
            dist/Directus-Desktop-${{ steps.version.outputs.version }}-Windows-x64-Setup.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
