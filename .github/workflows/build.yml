name: Build Directus 11.5.1 Electron App

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Directus 11.5.1
        shell: bash
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  Installing Directus 11.5.1"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          cd directus-app

          echo ""
          echo "ğŸ“¦ Running npm install..."
          npm install --production

          echo ""
          echo "âœ“ Installation complete"
          echo ""
          echo "Verifying installation:"
          ls -lh node_modules/directus/

          if [ -f "node_modules/directus/cli.js" ]; then
            echo "  âœ“ Directus CLI found"
          else
            echo "  âŒ Directus CLI not found!"
            exit 1
          fi

          echo ""
          echo "Checking package.json type:"
          if [ -f "node_modules/directus/package.json" ]; then
            grep '"type"' node_modules/directus/package.json || echo "  (no type field)"
          fi

      - name: Prepare Electron app
        shell: bash
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  Preparing Electron Application"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          # è·å–ç‰ˆæœ¬å·
          VERSION="${{ github.event.inputs.version || '1.0.0' }}"
          echo "Version: ${VERSION}"

          # å¤åˆ¶ Electron é…ç½®
          cp electron-app/package.json.template package.json
          cp electron-app/main.js main.js
          cp electron-app/preload.js preload.js

          # æ›¿æ¢ç‰ˆæœ¬å·
          sed -i "s/VERSION_PLACEHOLDER/${VERSION}/g" package.json

          # å¤åˆ¶å›¾æ ‡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [ -f "electron-app/icon.ico" ]; then
            cp electron-app/icon.ico icon.ico
          fi

          echo ""
          echo "âœ“ Electron app structure ready"
          echo ""
          echo "Structure:"
          ls -lh

      - name: Verify build structure
        shell: bash
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  Final Structure Verification"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          echo ""
          echo "Root files:"
          ls -lh *.js *.json 2>/dev/null || true

          echo ""
          echo "directus-app/ contents:"
          ls -lh directus-app/

          echo ""
          echo "Checking critical files:"

          files=(
            "package.json"
            "main.js"
            "preload.js"
            "directus-app/server.js"
            "directus-app/package.json"
            "directus-app/node_modules/directus/cli.js"
          )

          all_good=true
          for file in "${files[@]}"; do
            if [ -f "$file" ]; then
              echo "  âœ“ $file"
            else
              echo "  âŒ $file MISSING!"
              all_good=false
            fi
          done

          if [ "$all_good" = false ]; then
            echo ""
            echo "âŒ Some required files are missing!"
            exit 1
          fi

          echo ""
          echo "âœ… All files present, ready to build"

      - name: Install Electron dependencies
        run: npm install

      - name: Build Electron app
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npm run build -- --publish always

      - name: Verify build output
        shell: bash
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  Build Output Verification"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          echo ""
          echo "dist/ contents:"
          ls -lh dist/

          echo ""
          EXE_COUNT=$(find dist -name "*.exe" -type f | wc -l)
          echo "Found ${EXE_COUNT} .exe file(s)"

          if [ $EXE_COUNT -eq 0 ]; then
            echo ""
            echo "âŒ ERROR: No installer found!"
            echo ""
            echo "All files in dist/:"
            find dist -type f
            exit 1
          fi

          echo ""
          echo "âœ… Build successful"

      - name: Get version
        id: version
        shell: bash
        run: |
          if [ "${{ github.ref_type }}" == "tag" ]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION="${{ github.event.inputs.version }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Prepare release files
        shell: bash
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          cd dist

          # é‡å‘½åå®‰è£…åŒ…
          INSTALLER=$(find . -maxdepth 1 -name "*.exe" -type f | head -n 1)

          if [ -n "$INSTALLER" ]; then
            NEW_NAME="Directus-Desktop-${VERSION}-Windows-x64-Setup.exe"
            mv "$INSTALLER" "$NEW_NAME"
            echo "âœ“ Renamed to: $NEW_NAME"
          else
            echo "âŒ No installer found!"
            exit 1
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Directus Desktop v${{ steps.version.outputs.version }}
          body: |
            ## ğŸ‰ Directus Desktop v${{ steps.version.outputs.version }}

            åŸºäº **Directus 11.5.1** çš„ Windows æ¡Œé¢åº”ç”¨

            ### ğŸ“¥ å®‰è£…

            1. ä¸‹è½½ `Directus-Desktop-${{ steps.version.outputs.version }}-Windows-x64-Setup.exe`
            2. åŒå‡»è¿è¡Œå®‰è£…ç¨‹åº
            3. é¦–æ¬¡å¯åŠ¨ç­‰å¾…çº¦ 10 ç§’åˆå§‹åŒ–æ•°æ®åº“
            4. å¼€å§‹ä½¿ç”¨ï¼

            ### ğŸ” é»˜è®¤ç®¡ç†å‘˜è´¦å·

            - **é‚®ç®±**: `admin@example.com`
            - **å¯†ç **: `admin`

            âš ï¸ **è¯·åœ¨é¦–æ¬¡ç™»å½•åç«‹å³ä¿®æ”¹å¯†ç ï¼**

            ### âœ¨ ç‰¹æ€§

            - âœ… å®Œæ•´çš„ Directus 11.5.1 CMS åŠŸèƒ½
            - âœ… å†…ç½® SQLite æ•°æ®åº“
            - âœ… è‡ªåŠ¨æ›´æ–°æ”¯æŒ
            - âœ… å®Œå…¨ç¦»çº¿å¯ç”¨
            - âœ… ä¸€é”®å¯åŠ¨

            ### ğŸ“‚ æ•°æ®ä½ç½®

            ```
            C:\Users\<ç”¨æˆ·å>\AppData\Roaming\directus-desktop\
            â”œâ”€â”€ database\directus.db    (æ•°æ®åº“)
            â”œâ”€â”€ uploads\                 (æ–‡ä»¶)
            â””â”€â”€ directus.log            (æ—¥å¿—)
            ```

            ### ğŸ’¡ æç¤º

            - è®¿é—®åœ°å€: `http://localhost:8055/admin`
            - æŒ‰ F12 æ‰“å¼€å¼€å‘è€…å·¥å…·
            - æŸ¥çœ‹æ—¥å¿—: `%APPDATA%\directus-desktop\directus.log`

            ---

            **ç‰ˆæœ¬ä¿¡æ¯**
            - Directus: 11.5.1
            - Electron: 28.0.0
            - Node.js: 18.18.2
          draft: false
          prerelease: false
          files: |
            dist/Directus-Desktop-${{ steps.version.outputs.version }}-Windows-x64-Setup.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
