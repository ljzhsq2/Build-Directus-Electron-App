name: Build Directus Electron App

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

jobs:
  build:
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Directus via npm
        shell: bash
        run: |
          # åˆ›å»º Directus åº”ç”¨ç›®å½•
          mkdir -p directus-app
          cd directus-app
          
          # åˆå§‹åŒ– npm é¡¹ç›®å¹¶å®‰è£… Directus
          npm init -y
          npm install directus@11.5.1
          
          # åˆ›å»ºå¿…è¦çš„ç›®å½•
          mkdir -p extensions uploads database
          
          echo "Directus installed successfully"

      - name: Create Electron app structure
        shell: bash
        run: |
          # åˆ›å»º package.json
          cat > package.json << 'EOF'
          {
            "name": "directus-desktop",
            "version": "${{ github.event.inputs.version || '1.0.0' }}",
            "description": "Directus Desktop Application",
            "main": "main.js",
            "scripts": {
              "start": "electron .",
              "build": "electron-builder --win --x64"
            },
            "author": "Your Name",
            "license": "MIT",
            "devDependencies": {
              "electron": "^28.0.0",
              "electron-builder": "^24.9.1"
            },
            "build": {
              "appId": "com.directus.desktop",
              "productName": "Directus",
              "win": {
                "target": "nsis",
                "icon": "icon.ico"
              },
              "files": [
                "main.js",
                "preload.js",
                "directus-app/**/*",
                "!directus-app/node_modules/**/{CHANGELOG.md,README.md,README,readme.md,readme}",
                "!directus-app/node_modules/**/{test,__tests__,tests,powered-test,example,examples}",
                "!directus-app/node_modules/**/*.d.ts",
                "!directus-app/node_modules/.bin"
              ],
              "asarUnpack": [
                "directus-app/node_modules/**/*.node"
              ],
              "directories": {
                "output": "dist"
              },
              "nsis": {
                "oneClick": false,
                "allowToChangeInstallationDirectory": true
              }
            }
          }
          EOF

          # åˆ›å»º preload.js
          cat > preload.js << 'EOF'
          const { contextBridge, ipcRenderer } = require('electron');

          contextBridge.exposeInMainWorld('electronAPI', {
            getAppPath: () => ipcRenderer.invoke('get-app-path'),
            openExternal: (url) => ipcRenderer.invoke('open-external', url)
          });
          EOF

          # åˆ›å»º main.js
          cat > main.js << 'EOF'
          const { app, BrowserWindow, ipcMain, shell } = require('electron');
          const path = require('path');
          const { spawn } = require('child_process');
          const fs = require('fs');

          let mainWindow;
          let directusProcess;
          const PORT = 8055;

          function getDirectusPath() {
            if (app.isPackaged) {
              return path.join(process.resourcesPath, 'app.asar.unpacked', 'directus-app');
            }
            return path.join(__dirname, 'directus-app');
          }

          function startDirectus() {
            const directusAppPath = getDirectusPath();
            const directusCliPath = path.join(directusAppPath, 'node_modules', 'directus', 'dist', 'cli', 'index.js');
            const userDataPath = app.getPath('userData');
            const dbPath = path.join(userDataPath, 'database', 'directus.db');
            
            // ç¡®ä¿æ•°æ®åº“ç›®å½•å­˜åœ¨
            const dbDir = path.dirname(dbPath);
            if (!fs.existsSync(dbDir)) {
              fs.mkdirSync(dbDir, { recursive: true });
            }

            // è®¾ç½®ç¯å¢ƒå˜é‡
            const env = {
              ...process.env,
              PORT: PORT.toString(),
              HOST: '0.0.0.0',
              PUBLIC_URL: `http://localhost:${PORT}`,
              
              // æ•°æ®åº“é…ç½® - ä½¿ç”¨ SQLite
              DB_CLIENT: 'sqlite3',
              DB_FILENAME: dbPath,
              
              // å­˜å‚¨é…ç½®
              STORAGE_LOCATIONS: 'local',
              STORAGE_LOCAL_ROOT: path.join(userDataPath, 'uploads'),
              
              // æ‰©å±•é…ç½®
              EXTENSIONS_PATH: path.join(userDataPath, 'extensions'),
              
              // ç®¡ç†å‘˜é…ç½®ï¼ˆé¦–æ¬¡å¯åŠ¨ï¼‰
              ADMIN_EMAIL: 'admin@example.com',
              ADMIN_PASSWORD: 'admin',
              
              // å¯†é’¥ï¼ˆç”Ÿäº§ç¯å¢ƒåº”è¯¥æ›´å®‰å…¨ï¼‰
              KEY: 'directus-desktop-key-' + Date.now(),
              SECRET: 'directus-desktop-secret-' + Date.now(),
              
              // ç¦ç”¨é¥æµ‹
              TELEMETRY: 'false',
              
              NODE_ENV: 'production'
            };

            console.log('Starting Directus from:', directusCliPath);
            console.log('Database location:', dbPath);

            directusProcess = spawn(process.execPath, [directusCliPath, 'start'], {
              env: env,
              cwd: directusAppPath,
              stdio: ['ignore', 'pipe', 'pipe']
            });

            directusProcess.stdout.on('data', (data) => {
              console.log(`[Directus] ${data.toString().trim()}`);
            });

            directusProcess.stderr.on('data', (data) => {
              console.error(`[Directus Error] ${data.toString().trim()}`);
            });

            directusProcess.on('error', (error) => {
              console.error('Failed to start Directus:', error);
            });

            directusProcess.on('close', (code) => {
              console.log(`Directus process exited with code ${code}`);
            });
          }

          function createWindow() {
            mainWindow = new BrowserWindow({
              width: 1400,
              height: 900,
              webPreferences: {
                nodeIntegration: false,
                contextIsolation: true,
                preload: path.join(__dirname, 'preload.js')
              },
              icon: path.join(__dirname, 'icon.ico')
            });

            // æ˜¾ç¤ºåŠ è½½é¡µé¢
            mainWindow.loadURL(`data:text/html,
              <html>
                <body style="margin:0;padding:0;display:flex;align-items:center;justify-content:center;height:100vh;font-family:Arial,sans-serif;background:#f0f0f0;">
                  <div style="text-align:center;">
                    <h1>ğŸš€ Directus å¯åŠ¨ä¸­...</h1>
                    <p>è¯·ç¨å€™ï¼Œé¦–æ¬¡å¯åŠ¨å¯èƒ½éœ€è¦å‡ ç§’é’Ÿ</p>
                    <div style="margin-top:20px;">
                      <div style="width:200px;height:4px;background:#ddd;border-radius:2px;overflow:hidden;">
                        <div style="width:100%;height:100%;background:linear-gradient(90deg,#6644ff,#00bcd4);animation:slide 1.5s infinite;"></div>
                      </div>
                    </div>
                    <style>
                      @keyframes slide {
                        0% { transform: translateX(-100%); }
                        100% { transform: translateX(100%); }
                      }
                    </style>
                  </div>
                </body>
              </html>
            `);

            // ç­‰å¾… Directus å¯åŠ¨ååŠ è½½å®é™…é¡µé¢
            setTimeout(() => {
              checkDirectusReady();
            }, 8000);

            mainWindow.on('closed', () => {
              mainWindow = null;
            });

            // å¤„ç†å¤–éƒ¨é“¾æ¥
            mainWindow.webContents.setWindowOpenHandler(({ url }) => {
              shell.openExternal(url);
              return { action: 'deny' };
            });
          }

          function checkDirectusReady() {
            const http = require('http');
            
            const options = {
              hostname: 'localhost',
              port: PORT,
              path: '/admin',
              method: 'GET',
              timeout: 2000
            };

            const req = http.request(options, (res) => {
              if (res.statusCode === 200 || res.statusCode === 302) {
                mainWindow.loadURL(`http://localhost:${PORT}/admin`);
              } else {
                setTimeout(checkDirectusReady, 2000);
              }
            });

            req.on('error', () => {
              setTimeout(checkDirectusReady, 2000);
            });

            req.on('timeout', () => {
              req.destroy();
              setTimeout(checkDirectusReady, 2000);
            });

            req.end();
          }

          // IPC handlers
          ipcMain.handle('get-app-path', () => {
            return app.getPath('userData');
          });

          ipcMain.handle('open-external', (event, url) => {
            shell.openExternal(url);
          });

          app.on('ready', () => {
            startDirectus();
            createWindow();
          });

          app.on('window-all-closed', () => {
            if (directusProcess) {
              directusProcess.kill();
            }
            if (process.platform !== 'darwin') {
              app.quit();
            }
          });

          app.on('activate', () => {
            if (mainWindow === null) {
              createWindow();
            }
          });

          app.on('before-quit', () => {
            if (directusProcess) {
              directusProcess.kill();
            }
          });
          EOF

          echo "Electron app structure created"

      - name: Install dependencies
        run: npm install

      - name: Build Electron app
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npm run build

      - name: Get version
        id: version
        shell: bash
        run: |
          if [ "${{ github.ref_type }}" == "tag" ]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION="${{ github.event.inputs.version }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Rename installer
        shell: bash
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          cd dist
          # æ‰¾åˆ°ç”Ÿæˆçš„å®‰è£…åŒ…å¹¶é‡å‘½å
          for file in *.exe; do
            if [ -f "$file" ]; then
              NEW_NAME="Directus-Desktop-${VERSION}-Setup.exe"
              mv "$file" "$NEW_NAME"
              echo "Renamed to: $NEW_NAME"
              echo "installer_name=$NEW_NAME" >> $GITHUB_OUTPUT
            fi
          done

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Directus Desktop v${{ steps.version.outputs.version }}
          body: |
            ## ğŸ‰ Directus Desktop v${{ steps.version.outputs.version }}
            
            ### ğŸ“¦ å®‰è£…è¯´æ˜
            1. ä¸‹è½½ `Directus-Desktop-${{ steps.version.outputs.version }}-Setup.exe`
            2. è¿è¡Œå®‰è£…ç¨‹åº
            3. é¦–æ¬¡å¯åŠ¨ç­‰å¾…å‡ ç§’é’Ÿåˆå§‹åŒ–
            4. é»˜è®¤ç®¡ç†å‘˜è´¦å·ï¼š
               - é‚®ç®±ï¼š`admin@example.com`
               - å¯†ç ï¼š`admin`
            
            ### âœ¨ åŠŸèƒ½ç‰¹æ€§
            - âœ… å†…ç½® Directus 11.5.1
            - âœ… ä½¿ç”¨ SQLite æ•°æ®åº“
            - âœ… æ•°æ®å­˜å‚¨åœ¨ç”¨æˆ·ç›®å½•
            - âœ… æ— éœ€é…ç½®ï¼Œå¼€ç®±å³ç”¨
            
            ### ğŸ“‚ æ•°æ®ä½ç½®
            - Windows: `%APPDATA%\directus-desktop\database\`
            
            ---
            åŸºäº Directus 11.5.1 æ„å»º
          draft: false
          prerelease: false
          files: |
            dist/Directus-Desktop-${{ steps.version.outputs.version }}-Setup.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
