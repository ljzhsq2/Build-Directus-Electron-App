name: Build Directus Electron App

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

# æ·»åŠ æƒé™é…ç½®
permissions:
  contents: write  # å…è®¸åˆ›å»º Release å’Œä¸Šä¼ æ–‡ä»¶

jobs:
  extract-directus:
    runs-on: ubuntu-latest

    steps:
      - name: Extract Directus from Docker
        run: |
          echo "=== Extracting Directus from Docker ==="
          docker pull directus/directus:11.5.1

          docker create --name directus-temp directus/directus:11.5.1
          mkdir -p directus-app-temp

          # æå–æ–‡ä»¶ï¼ˆå®¹å¿ç¬¦å·é“¾æ¥é”™è¯¯ï¼‰
          docker cp directus-temp:/directus/. ./directus-app-temp/ || true
          docker rm directus-temp

          echo "=== Resolving Symlinks ==="
          mkdir -p directus-app

          # ä½¿ç”¨ rsync è§£æç¬¦å·é“¾æ¥ï¼ˆUbuntu è‡ªå¸¦ rsyncï¼‰
          rsync -aL --ignore-errors directus-app-temp/ directus-app/ 2>/dev/null || {
            echo "Some symlinks could not be resolved, continuing..."
          }
          rm -rf directus-app-temp

          # æ¸…ç†æ®‹ç•™ç¬¦å·é“¾æ¥
          find directus-app -type l -delete 2>/dev/null || true

          echo "=== Ensure package.json has type:module ==="
          # ç¡®ä¿ Directus çš„ package.json åŒ…å« "type": "module"
          if [ -f "directus-app/package.json" ]; then
            # å…ˆåˆ é™¤å·²å­˜åœ¨çš„ type å­—æ®µï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
            sed -i '/"type":/d' directus-app/package.json

            # åœ¨ç¬¬äºŒè¡Œæ’å…¥ "type": "module"
            sed -i '2i\  "type": "module",' directus-app/package.json

            echo "âœ“ Set type:module in package.json"

            # éªŒè¯
            if grep -q '"type": "module"' directus-app/package.json; then
              echo "  âœ“ Verified: type is set to module"
            else
              echo "  âœ— ERROR: Failed to set type to module"
              head -10 directus-app/package.json
            fi
          else
            echo "âœ— package.json not found!"
          fi

          echo "=== Disable Directus Singleton Check ==="
          # æŸ¥æ‰¾å¹¶ç¦ç”¨ Directus CLI çš„å•å®ä¾‹æ£€æµ‹
          # é€šå¸¸åœ¨ cli.js æˆ– dist/cli/index.js ä¸­
          for file in directus-app/cli.js directus-app/dist/cli.js directus-app/dist/cli/index.js directus-app/dist/cli/run.js; do
            if [ -f "$file" ]; then
              echo "Checking $file for singleton detection..."
              # æŸ¥æ‰¾å¸¸è§çš„å•å®ä¾‹æ£€æµ‹æ¨¡å¼å¹¶æ³¨é‡Šæ‰
              # æ¨¡å¼1: app.requestSingleInstanceLock()
              # æ¨¡å¼2: æ£€æŸ¥é”æ–‡ä»¶
              # æ¨¡å¼3: è¿›ç¨‹æ£€æµ‹
              sed -i 's/process\.exit(1);.*singleton/\/\/ process.exit(1); \/\/ Disabled singleton check/gi' "$file" 2>/dev/null || true
              sed -i 's/process\.exit(0);.*instance.*running/\/\/ process.exit(0); \/\/ Disabled singleton check/gi' "$file" 2>/dev/null || true
              sed -i 's/console\.log.*Another instance.*running/\/\/ Disabled singleton warning/gi' "$file" 2>/dev/null || true
              echo "  âœ“ Processed $file"
            fi
          done

          # æœç´¢åŒ…å« "instance" å’Œ "running" çš„æ–‡ä»¶
          echo "Searching for singleton detection code..."
          grep -r "Another instance" directus-app/ 2>/dev/null | head -5 || echo "  No obvious singleton messages found"

          echo "=== Packaging ==="
          tar -czf directus-files.tar.gz directus-app

          FILE_COUNT=$(find directus-app -type f | wc -l)
          echo "âœ… Packaged $FILE_COUNT files"
          ls -lh directus-files.tar.gz

      - name: Upload Directus files
        uses: actions/upload-artifact@v4
        with:
          name: directus-files
          path: directus-files.tar.gz
          retention-days: 1

  build-windows:
    needs: extract-directus
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Download Directus files
        uses: actions/download-artifact@v4
        with:
          name: directus-files

      - name: Extract Directus files
        shell: bash
        run: |
          echo "=== Extracting Directus archive ==="
          tar -xzf directus-files.tar.gz

          FILE_COUNT=$(find directus-app -type f | wc -l)
          echo "âœ… Extracted $FILE_COUNT files"

          # éªŒè¯å…³é”®æ–‡ä»¶
          if [ -f "directus-app/cli.js" ] || [ -f "directus-app/dist/cli.js" ]; then
            echo "âœ“ CLI found"
          else
            echo "âš ï¸ Warning: CLI entry point not obvious"
          fi

      - name: Copy Electron app files
        shell: bash
        run: |
          echo "=== Copying Electron App Files from Repository ==="

          # è·å–ç‰ˆæœ¬å·
          VERSION="${{ github.event.inputs.version || '1.0.0' }}"

          # å¤åˆ¶é…ç½®æ–‡ä»¶
          cp electron-app/package.json.template package.json
          cp electron-app/main.js main.js
          cp electron-app/preload.js preload.js

          # å¤åˆ¶ Directus åŒ…è£…å™¨åˆ° directus-app ç›®å½•
          echo "Copying directus-wrapper.mjs..."
          if [ -f "electron-app/directus-wrapper.mjs" ]; then
            cp electron-app/directus-wrapper.mjs directus-app/directus-wrapper.mjs
            echo "  âœ“ Copied directus-wrapper.mjs"
            ls -lh directus-app/directus-wrapper.mjs
          else
            echo "  âœ— ERROR: electron-app/directus-wrapper.mjs not found!"
            ls -la electron-app/
            exit 1
          fi

          # æ›¿æ¢ç‰ˆæœ¬å·
          sed -i "s/VERSION_PLACEHOLDER/${VERSION}/g" package.json

          echo "âœ“ Copied and configured all Electron files"
          echo "  - package.json (version: ${VERSION})"
          echo "  - main.js"
          echo "  - preload.js"
          echo "  - directus-wrapper.mjs â†’ directus-app/"
          echo ""
          echo "âœ… Electron app structure created successfully"

      - name: Create default icon
        shell: pwsh
        run: |
          Write-Host "=== Creating default icon ==="
          # åœ¨ Windows ä¸Š,æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ PowerShell åˆ›å»ºä¸€ä¸ªåŸºæœ¬çš„ ICO æ–‡ä»¶
          # æˆ–è€…ä»é¡¹ç›®ä¸­å¤åˆ¶,å¦‚æœä¸å­˜åœ¨åˆ™ electron-builder ä½¿ç”¨é»˜è®¤å›¾æ ‡

          # æ£€æŸ¥æ˜¯å¦æœ‰å›¾æ ‡æ–‡ä»¶åœ¨ä»“åº“ä¸­
          if (Test-Path "icon.ico") {
            Write-Host "âœ“ icon.ico already exists in repository"
          } elseif (Test-Path "assets/icon.ico") {
            Copy-Item "assets/icon.ico" "icon.ico"
            Write-Host "âœ“ Copied icon.ico from assets/"
          } else {
            Write-Host "âš ï¸ No icon.ico found. Electron-builder will use default Electron icon."
            Write-Host "   To use a custom icon, add icon.ico to the repository root or assets/ folder"
          }

      - name: Verify directus-app before build
        shell: bash
        run: |
          echo "=== Final Verification Before Build ==="

          if [ ! -d "directus-app" ]; then
            echo "âŒ ERROR: directus-app not found!"
            ls -la
            exit 1
          fi

          echo "âœ“ directus-app exists"
          echo ""

          echo "Size:"
          du -sh directus-app || echo "Size: $(find directus-app -type f | wc -l) files"
          echo ""

          echo "Key files check:"
          if [ -f "directus-app/cli.js" ]; then
            echo "  âœ“ cli.js"
          fi
          if [ -f "directus-app/directus-wrapper.mjs" ]; then
            echo "  âœ“ directus-wrapper.mjs"
          else
            echo "  âœ— directus-wrapper.mjs MISSING!"
            exit 1
          fi
          if [ -f "directus-app/package.json" ]; then
            echo "  âœ“ package.json"
          fi
          if [ -d "directus-app/node_modules" ]; then
            echo "  âœ“ node_modules"
          fi

          echo ""
          echo "Build config check:"
          if [ -f "package.json" ]; then
            echo "  âœ“ package.json (Electron)"
          fi
          if [ -f "main.js" ]; then
            echo "  âœ“ main.js"
          fi
          if [ -f "preload.js" ]; then
            echo "  âœ“ preload.js"
          fi

          echo ""
          echo "âœ… All required files present, ready to build"

      - name: Install Electron dependencies
        run: npm install

      - name: Build Electron app
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npm run build -- --publish always

      - name: Verify build output
        shell: bash
        run: |
          echo "=== Build Output Verification ==="
          echo ""
          echo "dist/ contents:"
          ls -lh dist/
          echo ""
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å¯æ‰§è¡Œæ–‡ä»¶
          EXE_COUNT=$(find dist -name "*.exe" -type f | wc -l)
          echo "Found $EXE_COUNT .exe file(s)"
          
          if [ $EXE_COUNT -eq 0 ]; then
            echo "âŒ ERROR: No .exe installer found!"
            echo ""
            echo "Looking for other files:"
            find dist -type f
            exit 1
          fi
          
          echo ""
          echo "âœ… Build verification passed"

      - name: Get version
        id: version
        shell: bash
        run: |
          if [ "${{ github.ref_type }}" == "tag" ]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION="${{ github.event.inputs.version }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Rename and prepare installer
        id: prepare
        shell: bash
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          cd dist
          
          # æ‰¾åˆ°ç”Ÿæˆçš„ exe å®‰è£…åŒ…
          INSTALLER_FILE=$(find . -maxdepth 1 -name "*.exe" -type f | head -n 1)
          
          if [ -n "$INSTALLER_FILE" ]; then
            NEW_NAME="Directus-Desktop-${VERSION}-Windows-x64-Setup.exe"
            mv "$INSTALLER_FILE" "$NEW_NAME"
            echo "âœ… Renamed installer to: $NEW_NAME"
            echo "installer_name=$NEW_NAME" >> $GITHUB_OUTPUT
          else
            echo "âŒ No installer file found!"
            exit 1
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Directus Desktop v${{ steps.version.outputs.version }}
          body: |
            ## ğŸ‰ Directus Desktop v${{ steps.version.outputs.version }}
            
            åŸºäº **Directus 11.5.1** çš„ Windows æ¡Œé¢ç‰ˆæœ¬
            
            ### ğŸ“¥ ä¸‹è½½ä¸å®‰è£…
            
            1. â¬‡ï¸ ä¸‹è½½ `Directus-Desktop-${{ steps.version.outputs.version }}-Windows-x64-Setup.exe`
            2. ğŸ–±ï¸ åŒå‡»è¿è¡Œå®‰è£…ç¨‹åº
            3. â±ï¸ é¦–æ¬¡å¯åŠ¨ç­‰å¾… 10-15 ç§’åˆå§‹åŒ–æ•°æ®åº“
            4. ğŸŠ å¼€å§‹ä½¿ç”¨ï¼
            
            ### ğŸ” é»˜è®¤ç®¡ç†å‘˜è´¦å·
            
            é¦–æ¬¡è®¿é—®æ—¶ä½¿ç”¨ä»¥ä¸‹è´¦å·ç™»å½•ï¼š
            - **é‚®ç®±**ï¼š`admin@example.com`
            - **å¯†ç **ï¼š`admin`
            
            âš ï¸ **é‡è¦**ï¼šç™»å½•åè¯·ç«‹å³ä¿®æ”¹å¯†ç ï¼
            
            ### âœ¨ åŠŸèƒ½ç‰¹æ€§
            
            - âœ… å®Œæ•´çš„ Directus CMS åŠŸèƒ½
            - âœ… å†…ç½® SQLite æ•°æ®åº“ï¼ˆæ— éœ€é¢å¤–é…ç½®ï¼‰
            - âœ… æ•°æ®è‡ªåŠ¨ä¿å­˜åˆ°ç”¨æˆ·ç›®å½•
            - âœ… æ”¯æŒæ–‡ä»¶ä¸Šä¼ å’Œç®¡ç†
            - âœ… å®Œå…¨ç¦»çº¿å¯ç”¨
            - âœ… ä¸€é”®å¯åŠ¨ï¼Œå¼€ç®±å³ç”¨
            - âœ… è¯¦ç»†çš„å¯åŠ¨æ—¥å¿—ï¼ˆæŒ‰ F12 æŸ¥çœ‹å®æ—¶æ—¥å¿—ï¼‰
            
            ### ğŸ“‚ æ•°æ®å­˜å‚¨ä½ç½®
            
            æ‰€æœ‰æ•°æ®ä¿å­˜åœ¨ï¼š
            ```
            C:\Users\<ä½ çš„ç”¨æˆ·å>\AppData\Roaming\directus-desktop\
            â”œâ”€â”€ database\
            â”‚   â””â”€â”€ directus.db      (æ•°æ®åº“æ–‡ä»¶)
            â”œâ”€â”€ uploads\             (ä¸Šä¼ çš„æ–‡ä»¶)
            â”œâ”€â”€ extensions\          (æ‰©å±•æ’ä»¶)
            â””â”€â”€ directus.log         (å¯åŠ¨æ—¥å¿—)
            ```
            
            ### ğŸ’¡ ä½¿ç”¨æç¤º
            
            - è®¿é—®åœ°å€ï¼š`http://localhost:8055/admin`
            - å¯åŠ¨æ—¶ä¼šæ˜¾ç¤ºå®æ—¶æ—¥å¿—ï¼Œæ–¹ä¾¿æ’æŸ¥é—®é¢˜
            - æŒ‰ F12 å¯ä»¥æ‰“å¼€å¼€å‘è€…å·¥å…·æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
            - å…³é—­çª—å£å³åœæ­¢æœåŠ¡
            - å¸è½½ä¸ä¼šåˆ é™¤æ•°æ®ï¼Œéœ€æ‰‹åŠ¨åˆ é™¤ä¸Šè¿°ç›®å½•
            
            ### ğŸ› é‡åˆ°é—®é¢˜ï¼Ÿ
            
            1. **æŸ¥çœ‹æ—¥å¿—**ï¼š`C:\Users\<ç”¨æˆ·å>\AppData\Roaming\directus-desktop\directus.log`
            2. **ç«¯å£å ç”¨**ï¼šç¡®ä¿ 8055 ç«¯å£æœªè¢«å ç”¨
            3. **é‡ç½®æ•°æ®**ï¼šåˆ é™¤ `directus.db` æ–‡ä»¶é‡æ–°åˆå§‹åŒ–
            4. **æäº¤ Issue**ï¼šé™„ä¸Šæ—¥å¿—æ–‡ä»¶å†…å®¹
            
            ### ğŸ”§ æœ¬æ¬¡æ›´æ–°
            
            - âœ… ä¿®å¤äº† Docker æ–‡ä»¶æå–å’Œæ‰“åŒ…é—®é¢˜
            - âœ… ä¼˜åŒ–äº†è·¯å¾„æŸ¥æ‰¾é€»è¾‘ï¼Œæ”¯æŒå¤šç§ CLI ä½ç½®
            - âœ… æ·»åŠ äº†è¯¦ç»†çš„å¯åŠ¨æ—¥å¿—å’Œé”™è¯¯æç¤º
            - âœ… æ”¹è¿›äº† electron-builder é…ç½®ï¼Œç¡®ä¿æ–‡ä»¶æ­£ç¡®æ‰“åŒ…
            - âœ… åŠ å¼ºäº†ç›®å½•éªŒè¯å’Œé”™è¯¯å¤„ç†
            
            ---
            
            ğŸ“¦ **æ–‡ä»¶ä¿¡æ¯**
            - ç‰ˆæœ¬ï¼šv${{ steps.version.outputs.version }}
            - Directus ç‰ˆæœ¬ï¼š11.5.1
            - æ¶æ„ï¼šWindows x64
            - å®‰è£…åŒ…å¤§å°ï¼š~150MB
            - å®‰è£…åå¤§å°ï¼š~300MB
          draft: false
          prerelease: false
          files: |
            dist/Directus-Desktop-${{ steps.version.outputs.version }}-Windows-x64-Setup.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
